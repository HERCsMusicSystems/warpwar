<meta charset="UTF-8"/>
<html>
	<head>
		<title>Warpwar</title>
	</head>


<body bgcolor="#000033" style="background-size: cover; padding: 0px; margin: 0px;" onresize="javascript: repaint ();">

<div id="BuildPanel" style="position: absolute; left: 8px; top: 8px; border-radius: 8px; padding: 8px; background-color: gold; font-family: arial;">
	<input type="button" value="Build" onclick="javascript: BuildShip (); repaint ();"/>
	<input type="button" value="Reset" onclick="javascript: BuildShipReset ();"/><br/>
	Location:<select id="BuildLocations"></select><br/>
	Warp Generator: <input type="checkbox" id="BuildWarpGenerator"/><br/>
	Power Drive: <input type="number" min="0" value="0" style="width: 5em;" id="BuildPowerDrive"/><br/>
	Beams: <input type="number" min="0" value="0" style="width: 5em;" id="BuildBeams"/><br/>
	Shields: <input type="number" min="0" value="0" style="width: 5em;" id="BuildShields"/><br/>
	Tubes: <input type="number" min="0" value="0" style="width: 5em;" id="BuildTubes"/><br/>
	Missiles: <input type="number" min="0" value="0" style="width: 5em;" id="BuildMissiles"/><br/>
	Bays: <input type="number" min="0" value="0" style="width: 5em;" id="BuildBays"/><br/>
	<hr/>
	Repair Bay: <input type="checkbox" id="BuildRepairBay"/><br/>
	ECM: <input type="number" min="0" value="0" style="width: 5em;" id="BuildECM"/><br/>
	Armor: <input type="number" min="0" value="0" style="width: 5em;" id="BuildArmor"/><br/>
	Cannons: <input type="number" min="0" value="0" style="width: 5em;" id="BuildCannons"/><br/>
	Shells: <input type="number" min="0" value="0" style="width: 5em;" id="BuildShells"/><br/>
	Holds: <input type="number" min="0" value="0" style="width: 5em;" id="BuildHolds"/><br/>
</div>
<div id="CombatPanel" style="position: absolute; left: 8px; top: 8px; border-radius: 8px; padding: 8px; background-color: gold; font-family: arial;">
	<div id="CombatLocationDiv" style="float: left;">sputnik</div>
	<select id="CombatLocation" onchange="javascript: if (this . value !== 'select') galaxy . CombatLocation = this . value; repaint ();"></select><br/>
	<select id="CombatShip" onchange="javascript: if (this . value !== 'select') galaxy . CombatShip = this . value; repaint ();"></select>
	<div id="CombatShipData">
	</div>
</div>
<!--<div style="position: absolute; bottom: 8px; left: 8px; border-radius: 8px; padding: 8px; background-color: gold; font-family: arial;">
	<input type="button" value="Collect" onclick="javascript: galaxy . Collect (); repaint ();"/>
	<input type="button" value="ReMove" onclick="javascript: galaxy . ReMoveShips (); repaint ();"/>
	<input type="button" value="Store" onclick="javascript: galaxy . store ();"/>
	<input type="button" value="Restore" onclick="javascript: galaxy . restore (); repaint ();"/>
	<input type="button" value="Next" onclick="javascript: galaxy . Next (); repaint ();"/>
</div>-->
<!--<div id="Ships" style="visibility: hidden; position: absolute; background-color: #44444444; border-radius: 8px; padding: 8px; top: 8px; left: 256px;">
	<img src="g1.png"/><img src="g2.png"/><img src="g3.png"/><img src="g4.png"/><img src="g5.png"/><img src="g6.png"/>
	<img src="g7.png"/><img src="g8.png"/><img src="g9.png"/><br/>
	<img src="s1.png"/><img src="s2.png"/><img src="s3.png"/><img src="s4.png"/><img src="s5.png"/><img src="s6.png"/><img src="s7.png"/>
	<img src="s8.png"/><img src="s9.png"/><br/><img src="s10.png"/><img src="s11.png"/><img src="s12.png"/><img src="s13.png"/>
	<img src="s14.png"/><img src="s15.png"/><img src="s16.png"/><img src="s17.png"/><img src="s18.png"/><br/>
	<img src="g11.png"/><img src="g12.png"/><img src="g13.png"/><img src="g14.png"/><img src="g15.png"/><img src="g16.png"/>
	<img src="g17.png"/><img src="g18.png"/><img src="g19.png"/><br/>
	<img src="s21.png"/><img src="s22.png"/><img src="s23.png"/><img src="s24.png"/><img src="s25.png"/><img src="s26.png"/><img src="s27.png"/>
	<img src="s28.png"/><img src="s29.png"/><br/><img src="s30.png"/><img src="s31.png"/><img src="s32.png"/><img src="s33.png"/>
	<img src="s34.png"/><img src="s35.png"/><img src="s36.png"/><img src="s37.png"/><img src="s38.png"/>
</div>-->

<div id="SelectedShip" style="position: absolute; right: 8px; top: 8px; border-radius: 8px; padding: 8px; background-color: gold; font-family: arial;">
	<select id="ShipsForSelection" onchange="javascript: ShipSelect (this . value);"/></select>
	<div id="ShipData"/></div>
</div>

<div id="CreateRace" style="position: absolute; bottom: 8px; right: 8px; background-color: gold; border-radius: 8px; font-family: arial; padding: 8px;">
	<div id="CreateRaces" style="float: left;"><table><tr><td>RACES:</td></tr></table></div>
	<div align="right" style="background-color: gold;">
		<input type="button" value="Store" onclick="javascript: galaxy . store ();"/>
		<input type="button" value="Restore" onclick="javascript: galaxy . restore (); repaint ();"/>
		<input type="button" value="Next" onclick="javascript: galaxy . Next (); repaint ();"/>
	</div>
	<nobr><input type="button" value="Create New Race" onclick="javascript: if (document . getElementById ('CreateRaceName') . value . length > 0) {galaxy . CreateRace (document . getElementById ('CreateRaceName') . value, document . getElementById ('CreateRaceStar') . value, document . getElementById ('CreateRaceColour') . value); repaint ();} else alert ('No name for new race.');"/>
	<input type="text" id="CreateRaceName"/>
	<select id="CreateRaceStar">
	</select>
	<select id="CreateRaceColour">
		<option value="#6666ff" style="background-color: blue;">Blue</option>
		<option value="crimson" style="background-color: crimson;">Crimson</option>
		<option value="purple" style="background-color: indigo;">Purple</option>
		<option value="green" style="background-color: green;">Green</option>
		<option value="sienna" style="background-color: sienna;">Sienna</option>
		<option value="olive" style="background-color: olive;">Olive</option>
	</select></nobr>
</div>

<canvas id="canvas" onmousedown="javascript: return OnMouseDown (event);" onmousemove="javascript: OnMouseMove (event);" onmouseup="javascript: OnMouseUp (event);" oncontextmenu="javascript: event . preventDefault ();" width="400" height="200"/>

<script>

var SelectedShip = null;

var UpdateShipSelectDiv = function () {
	// console . log (galaxy . SelectedShip);
	if (! SelectedShip) document . getElementById ('ShipData') . innerHTML = '';
	else {
		var ship = SelectedShip . ship;
		var text = `<img src="${ship . icon}"/><br/><font color="${ship . colour}">${ship . race} ${ship . name}: ${ship . move}<br/>`;
		if (typeof ship . location === 'string') {
			if (galaxy . stars [ship . location]) text += `${ship . location} ${galaxy . stars [ship . location] . economy}`;
			else text += `${ship . location} docked`;
			var base = galaxy . races [ship . race] . bases [ship . location];
			if (base) {
			 	if (base . construction < 30) text += ` <${base . construction}>`; else text += ` [${base . BuildPoints}]`;
			}
		} else text += `Space [${ship . location . x} : ${ship . location . y}]`;
		text += `</font><br/>`;
		if (ship . race === galaxy . Turns [0]) {
			var CanRepair = SelectedShip . CanRepair ();
			if (CanRepair && ! SelectedShip . source) SelectedShip . Source (CanRepair);
			if (SelectedShip . source && galaxy . Phase === 'build') {
				text += `Source: ${SelectedShip . SourceName}`;
				if (SelectedShip . source . name) {
					text += ` <select id="SelectSource" onchange="javascript: if (this . value !== 'Select Source') SelectedShip . Source (this . value); repaint ();">`;
					text += `<option value="Select Source">Select Source</option>`;
					for (var s in galaxy . races [ship . race] . ships) {
						var S = galaxy . races [ship . race] . ships [s];
						if (S . Holds > 0) text += `<option value="${S . name}">${S . name}</option>`;
					}
					text += `</select>`;
				}
			}
			text += '<hr/>';
			if (ship . WarpGenerator) text += 'Warp Generator<br/>';
			text += `Power Drive = ${ship . PowerDrive} [${ship . original . PowerDrive}]`;
			if (CanRepair && ship . original . PowerDrive > ship . PowerDrive) text += ` <input type="button" value="REPAIR" style="padding: 0px;" onclick="javascript: SelectedShip . Repair ('PowerDrive', 1); repaint ();"/>`;
			text += `<br/>`;
			if (ship . original . Beams > 0) {
				text += `Beams = ${ship . Beams} [${ship . original . Beams}]`;
				if (CanRepair && ship . original . Beams > ship . Beams) text += ` <input type="button" value="REPAIR" style="padding: 0px;" onclick="javascript: SelectedShip . Repair ('Beams', 1); repaint ();"/>`;
				text += '<br/>';
			}
			if (ship . original . Shields > 0) {
				text += `Shields = ${ship . Shields} [${ship . original . Shields}]`;
				if (CanRepair && ship . original . Shields > ship . Shields) text += ` <input type="button" value="REPAIR" style="padding: 0px;" onclick="javascript: SelectedShip . Repair ('Shields', 1); repaint ();"/>`;
				text += `<br/>`;
			}
			if (ship . original . Tubes > 0) {
				text += `Tubes = ${ship . Tubes} [${ship . original . Tubes}]`;
				if (CanRepair && ship . original . Tubes > ship . Tubes) text += ` <input type="button" value="REPAIR" style="padding: 0px;" onclick="javascript: SelectedShip . Repair ('Tubes', 1); repaint ();"/>`;
				text += `<br/>`;
			}
			if (ship . original . Missiles > 0) {
				text += `Missiles = ${ship . Missiles} [${ship . original . Missiles}]`;
				if (CanRepair && ship . original . Missiles > ship . Missiles) text += ` <input type="button" value="REFILL" style="padding: 0px;" onclick="javascript: SelectedShip . Repair ('Missiles', 1, 3); repaint ();"/>`;
				text += `<br/>`;
				for (var ind = 0; ind < ship . Missiles; ind ++) text += `<img src="Harpoon.png" width="128px;"/><br/>`;
			}
			if (ship . original . Bays > 0) {
				text += `Bays = ${ship . Bays . length} [${ship . original . Bays}]<br/>`;
				text += `<table><tr>`;
				for (var ind in ship . Bays) {
					if (ship . Bays [ind] === null) {
						text += `<td style="background-color: gray;">EMPTY<br/>`;
						if (typeof ship . location === 'string') {
							if (galaxy . Phase !== 'combat') {
								text += `<select onchange="javascript: SelectedShip . Pick (this . value, '${ind}'); if (this . value !== 'Pick') repaint ();"><option>Pick</option>`;
								for (var s in galaxy . races [ship . race] . ships) {
									var ss = galaxy . races [ship . race] . ships [s];
									if (ss . location === ship . location && ! ss . WarpGenerator) text += `<option value="${ss . name}">${ss . name}</option>`;
								}
								text += `</select>`;
							}
						}
						text += `</td>`;
					} else if (ship . Bays [ind] === 'damage') {
						text += `<td style="background-color: gray;" align="center">DAMAGED`;
						if (CanRepair) text += `<br/><input type="button" value="REPAIR" onclick="javascript: SelectedShip . BayRepair (${ind}); repaint();"/>`;
						text += `</td>`;
					} else {
						var Docked = galaxy . races [ship . race] . ships [ship . Bays [ind]];
						text += `<td style="background-color: red; text-align: center;"><img src="${Docked . icon}" width="64"/><br/>`;
						if (typeof ship . location === 'string') {
							if (galaxy . Phase === 'combat') text += Docked . name;
							else text += `<input type="button" value="${Docked . name}" onclick="javascript: SelectedShip . Drop (${ind}); repaint ();"/>`;
						} else text += `${Docked . name}`;
						text += `</td>`;
					}
				}
				text += `</table></tr>`;
			}
			text += '<hr/>';
			if (ship . RepairBay) text += 'Repair Bay<br/>';
			if (ship . original . ECM > 0) {
				text += `ECM = ${ship . ECM} [${ship . original . ECM}]`;
				if (CanRepair && ship . original . ECM > ship . ECM) text += ` <input type="button" value="REPAIR" style="padding: 0px;" onclick="javascript: SelectedShip . Repair ('ECM', 1); repaint ();"/>`;
				text += `<br/>`;
			}
			if (ship . original . Armor > 0) {
				text += `Armor = ${ship . Armor} [${ship . original . Armor}]`;
				if (CanRepair && ship . original . Armor > ship . Armor) text += ` <input type="button" value="REPAIR" style="padding: 0px;" onclick="javascript: SelectedShip . Repair ('Armor', 1, 2); repaint ();"/>`;
				text += `<br/>`;
			}
			if (ship . original . Cannons > 0) {
				text += `Cannons = ${ship . Cannons} [${ship . original . Cannons}]`;
				if (CanRepair && ship . original . Cannons > ship . Cannons) text += ` <input type="button" value="REPAIR" style="padding: 0px;" onclick="javascript: SelectedShip . Repair ('Cannons', 1); repaint ();"/>`;
				text += `<br/>`;
				for (var ind = 0; ind < ship . Cannons; ind ++) {
					text += ` <img src="Cannon.png"/> `;
				}
				text += `<br/>`;
			}
			if (ship . original . Shells > 0) {
				text += `Shells = ${ship . Shells} [${ship . original . Shells}]`;
				if (CanRepair && ship . original . Shells > ship . Shells) text += ` <input type="button" value="REPAIR" style="padding: 0px;" onclick="javascript: SelectedShip . Repair ('Shells', 1, 6); repaint ();"/>`;
				text += `<br/>`;
			}
			if (ship . original . Holds > 0) {
				text += `Holds = ${ship . Holds} [${ship . original . Holds}]`;
				if (CanRepair && ship . original . Holds > ship . Holds) text += ` <input type="button" value="REPAIR" style="padding: 0px;" onclick="javascript: SelectedShip . Repair ('Holds', 1, 10); repaint ();"/>`;
				text += `<br/>`;
				text += `Build Points = ${ship . BuildPoints}<br/>`;
				if (typeof ship . location === 'string' && galaxy . Phase === 'build') {
					text += `<input type="button" value="LOAD" onclick="javascript: galaxy . LoadBuildPoints ('${ship . race}', '${ship . name}', 1); repaint ();" style="padding: 0px;"/>`;
					text += `<input type="button" value="UNLOAD" onclick="javascript: galaxy . LoadBuildPoints ('${ship . race}', '${ship . name}', -1); repaint ();" style="padding: 0px;"/>`;
				}
			}
			
		}
		document . getElementById ('ShipData') . innerHTML = text;
	}
};

var SelectTarget = function (Order, order, value) {
	if (value === 'select') return;
	if (value === 'null') value = null;
	else {
		if (Order !== order) {Order . Beams = 0; Order . Shields = 0;}
		if (OrderTotalPD (Order) + 1 > galaxy . races [Order . race] . ships [Order . ship] . PowerDrive) return;
	}
	order . Target = value;
};

var SelectPDForTube = function (ship, tube, delta) {
	var Tube = galaxy . Orders [ship] . Tubes [tube];
	Tube . PowerDrive += delta;
	if (Tube . PowerDrive < 0) Tube . PowerDrive = 0;
};

var SelectShipForPickup = function (Warship, Bay, Systemship) {
	if (Systemship === 'select') return;
	if (Systemship === 'null') Systemship = null;
	galaxy . Orders [Warship] . Bays [Bay] = Systemship;
};

var DropShip = function (ship, bay, value) {
	var Order = galaxy . Orders [ship];
	if (value) {Order . PowerDrive = 0; Order . Shields = 0; if (Order . Strategy === 'ATTACK') Order . Strategy = 'DODGE';}
	// if (OrderTotalPD (Order) + 1 > galaxy . races [Order . races] . ships [Order . ship] . PowerDrive) return;
	Order . Bays [bay] = value ? 'drop' : null;
};

var UpdateCombatPanel = function () {
	var combats = galaxy . Combats ();
	document . getElementById ('CombatLocationDiv') . innerHTML = galaxy . CombatLocation;
	document . getElementById ('CombatLocation') . options . length = 0;
	document . getElementById ('CombatLocation') . options . add (new Option ('Select Combat Location', 'select'));
	for (var ind in combats) {
		document . getElementById ('CombatLocation') . options . add (new Option (combats [ind], combats [ind]));
	}
	document . getElementById ('CombatShip') . options . length = 0;
	document . getElementById ('CombatShip') . options . add (new Option ('Select Combat Ship', 'select'));
	for (var race in galaxy . races) {
		var Race = galaxy . races [race];
		for (var ship in Race . ships) {
			var Ship = Race . ships [ship];
			if (Ship . location === galaxy . CombatLocation) document . getElementById ('CombatShip') . options . add (new Option (`${race}: ${ship}`, ship));
		}
	}
	if (galaxy . CombatShip) {
		var ship = null;
		for (var race in galaxy . races) {
			var Race = galaxy . races [race];
			if (Race . ships [galaxy . CombatShip]) ship = Race . ships [galaxy . CombatShip];
		}
		if (ship) {
			var text = `<div style="float: left;"><img src="${ship . icon}"/><br/>`;
			text += `<font color="${ship . colour}">${ship . race} ${ship . name}</font>`;
			text += `<hr/>`;
			var order = galaxy . Orders [ship . name];
			text += `Strategy: ${order . Strategy} `;
			text += `<select onchange="javascript: if (this . value !== 'select') galaxy . Orders ['${ship . name}'] . Strategy = this . value; repaint ();">`;
			text += `<option value="select">Select Strategy</option>`;
			text += `<option value="ATTACK">ATTACK</option>`;
			text += `<option value="DODGE">DODGE</option>`;
			text += `<option value="RETREAT">RETREAT</option>`;
			text += `</select><br/>`;
			text += `Target: `;
			if (order . Target) text += `${order . Target} <img src="${galaxy . Ship (order . Target) . icon}" width="64"/> `;
			text += `<br/>`;
			text += `<select onchange="javascript: SelectTarget (galaxy . Orders ['${ship . name}'], galaxy . Orders ['${ship . name}'], this . value); repaint ();">`;
			var TargetOptions = `<option value="select">Select Target</option>`;
			TargetOptions += `<option value="null">NO TARGET</option>`;
			for (var race in galaxy . races) {
				var Race = galaxy . races [race];
				for (var ss in Race . ships) {
					var SS = Race . ships [ss];
					if (SS . location === ship . location && SS . race !== ship . race)
						TargetOptions += `<option value="${SS . name}">${SS . race}: ${SS . name}</option>`;
				}
			}
			text += `${TargetOptions}</select><br/>`;
			text += `<table>`;
			text += `<tr><td>Power Drive [${ship . PowerDrive}]: ${order . PowerDrive}</td><td>`;
			text += `<input type="button" value="▲" style="padding: 0px;" onclick="javascript: OrderAttr ('${ship . name}', 1, 'PowerDrive'); repaint ();"/>`;
			text += `<input type="button" value="▼" style="padding: 0px;" onclick="javascript: OrderAttr ('${ship . name}', -1, 'PowerDrive'); repaint ();"/></td></tr>`;
			text += `<tr><td>Beams [${ship . Beams}]: ${order . Beams}</td><td>`;
			text += `<input type="button" value="▲" style="padding: 0px;" onclick="javascript: OrderAttr ('${ship . name}', 1, 'Beams'); repaint ();"/>`;
			text += `<input type="button" value="▼" style="padding: 0px;" onclick="javascript: OrderAttr ('${ship . name}', -1, 'Beams'); repaint ();"/></td></tr>`;
			text += `<tr><td>Shields [${ship . Shields}]: ${order . Shields}</td><td>`;
			text += `<input type="button" value="▲" style="padding: 0px;" onclick="javascript: OrderAttr ('${ship . name}', 1, 'Shields'); repaint ();"/>`;
			text += `<input type="button" value="▼" style="padding: 0px;" onclick="javascript: OrderAttr ('${ship . name}', -1, 'Shields'); repaint ();"/></td></tr>`;
			text += `<tr><td>ECM [${ship . ECM}]: ${order . ECM}</td><td>`;
			text += `<input type="button" value="▲" style="padding: 0px;" onclick="javascript: OrderAttr ('${ship . name}', 1, 'ECM'); repaint ();"/>`;
			text += `<input type="button" value="▼" style="padding: 0px;" onclick="javascript: OrderAttr ('${ship . name}', -1, 'ECM'); repaint ();"/></td></tr>`;
			text += `</table>`;
			if (order . Bays . length > 0) {
				text += `<hr/>`;
				text += `<table><tr>`;
				var Systemships = `<option value="select">Pickup</option>`;
				Systemships += `<option value="null">NO PICKUP</option>`;
				for (var shipname in galaxy . races [ship . race] . ships) {
					var Systemship = galaxy . races [ship . race] . ships [shipname];
					if (Systemship . location === ship . location && ! Systemship . WarpGenerator)
						Systemships += `<option value="${shipname}">${shipname}</option>`;
				}
				for (var ind = 0; ind < order . Bays . length; ind ++) {
					if (ship . Bays [ind] === null) {
						text += `<td style="background-color: gray;" align="center">EMPTY<br/>`;
						if (order . Bays [ind] !== null) text += `${order . Bays [ind]}<br/>`;
						text += `<select onchange="javascript: SelectShipForPickup ('${ship . name}', ${ind}, this . value); repaint ();">`;
						text += Systemships;
						text += `</select>`;
						text += `</td>`;
					} else if (ship . Bays [ind] === 'damage') {
						text += `<td style="background-color: gray;" align="center">DAMAGED</td>`;
					} else {
						var Docked = galaxy . Ship (ship . Bays [ind]);
						text += `<td style="background-color: red;" align="center"><img src="${Docked . icon}" width="64"/><br/>${Docked . name}`;
						text += `<input type="checkbox" ${order . Bays [ind] === 'drop' ? 'checked' : ''} onchange="javascript: DropShip ('${ship . name}', ${ind}, this. checked); repaint ();"/></td>`;
					}
				}
				text += `</tr></table>`;
			}
			text += `</div>`;
			text += `<div style="float: right;">`;
			text += `<hr/>`;
			text += `Cannons [${ship . original . Cannons}]: ${ship . Cannons}<br/>`;
			text += `<table>`;
			for (var cannon = 0; cannon < galaxy . Orders [ship . name] . Cannons . length; cannon ++) {
				var CannonOrder = galaxy . Orders [ship . name] . Cannons [cannon];
				var TargetShip = galaxy . Ship (CannonOrder . Target);
				text += `<tr><td align="bottom">`;
				text += `<img src="Cannon.png"/> ${CannonOrder . Shells}`;
				text += `<input name="Cannon ${cannon}" type="radio" ${CannonOrder . Shells === 1 ? 'checked' : ''} onchange="javascript: galaxy . Orders ['${ship . name}'] . Cannons [${cannon}] . Shells = 1; repaint ();"/>`;
				text += `<input name="Cannon ${cannon}" type="radio" ${CannonOrder . Shells === 2 ? 'checked' : ''} onchange="javascript: galaxy . Orders ['${ship . name}'] . Cannons [${cannon}] . Shells = 2; repaint ();"/>`;
				text += `<input name="Cannon ${cannon}" type="radio" ${CannonOrder . Shells === 3 ? 'checked' : ''} onchange="javascript: galaxy . Orders ['${ship . name}'] . Cannons [${cannon}] . Shells = 3; repaint ();"/>`;
				text += `<br/>`;
				text += `<select onchange="javascript: SelectTarget (galaxy . Orders ['${ship . name}'], galaxy . Orders ['${ship . name}'] . Cannons [${cannon}], this . value); repaint ();">`;
				text += TargetOptions;
				text += `</select><br/>`;
				text += `</td><td valign="bottom">`;
				if (TargetShip) text += `<img src="${TargetShip . icon}" width="64"/><br/>${CannonOrder . Target}<br/>`;
				text += `</td></tr>`;
			}
			text += `</table>`;
			text += `<hr/>`;
			text += `Tubes [${ship . original . Tubes}]: ${ship . Tubes}<br/>`;
			text += `<table>`;
			for (var tube = 0; tube < galaxy . Orders [ship . name] . Tubes . length; tube ++) {
				var TubeOrder = galaxy . Orders [ship . name] . Tubes [tube];
				var TargetShip = galaxy . Ship (TubeOrder . Target);
				text += `<tr><td valign="bottom">`;
				text += `<img src="Harpoon.png" width="128"/> `;
				text += `<br/>`;
				text += `<select onchange="javascript: SelectTarget (galaxy . Orders ['${ship . name}'], galaxy . Orders ['${ship . name}'] . Tubes [${tube}], this . value); repaint ();">`;
				text += TargetOptions;
				text += `</select><br/>`;
				text += `Drive: ${TubeOrder . PowerDrive} `;
				text += `<input type="button" value="▲" style="padding: 0px;" onclick="javascript: SelectPDForTube ('${ship . name}', ${tube}, 1); repaint ();"/>`;
				text += `<input type="button" value="▼" style="padding: 0px;" onclick="javascript: SelectPDForTube ('${ship . name}', ${tube}, -1); repaint ();"/>`;
				text += `</td><td valign="bottom">`;
				if (TargetShip) text +=  `<img src="${TargetShip . icon}" width="64"/><br/>${TubeOrder . Target}<br/>`;
				text += `</td></tr>`;
			}
			text += `</table>`;
			text += `<hr/>`;
			text += `</div>`;
			document . getElementById ('CombatShipData') . innerHTML = text;
		}
	}
};

var OrderTotalPD = function (Order) {
	var total = Order . PowerDrive + Order . Beams + Order . Shields + Order . ECM;
	for (var ind = 0; ind < Order . Bays . length; ind ++) {if (Order . Bays [ind]) total ++;}
	for (var ind = 0; ind < Order . Tubes . length; ind ++) {if (Order . Tubes [ind] . Target) total ++;}
	for (var ind = 0; ind < Order . Cannons . length; ind ++) {if (Order . Cannons [ind] . Target) total ++;}
	return total;
};

var OrderAttr = function (ship, delta, attr) {
	var Order = galaxy . Orders [ship];
	var Ship = galaxy . races [Order . race] . ships [ship];
	if (attr === 'Beams' || attr === 'Shields') {
		for (var ind = 0; ind < Order . Tubes . length; ind ++) Order . Tubes [ind] . Target = null;
		for (var ind = 0; ind < Order . Cannons . length; ind ++) Order . Cannons [ind] . Target = null;
	}
	if (OrderTotalPD (Order) + delta > Ship . PowerDrive) return;
	Order [attr] += delta; if (Order [attr] < 0) Order [attr] = 0; if (Order [attr] > Ship [attr]) Order [attr] = Ship [attr];
}

var RestoreSelects = function () {
	var Stars = [];
	for (var star in galaxy . stars) Stars . push (star);
	Stars . sort ();
	document . getElementById ('CreateRaceStar') . options . length = 0;
	for (var star of Stars) {
		document . getElementById ('CreateRaceStar') . add (new Option (`${galaxy . stars [star] . economy}: ${star}`, star));
		// document . getElementById ('BuildLocations') . add (new Option (`${star} ${galaxy . stars [star] . economy}`, star));
	}
	document . getElementById ('BuildLocations') . options . length = 0;
	if (galaxy . Turns . length > 0) {
		for (var base in galaxy . races [galaxy . Turns [0]] . bases) {
			var Base = galaxy . races [galaxy . Turns [0]] . bases [base];
			var Star = galaxy . stars [base];
			if (Base . construction < 30) document . getElementById ('BuildLocations') . add (new Option (`${Star . economy}: ${base} <${Base . construction}>`, base));
			else document . getElementById ('BuildLocations') . add (new Option (`${Star . economy}: ${base} [${Base . BuildPoints}]`, base));
		}
	}
	document . getElementById ('ShipsForSelection') . options . length = 0;
	document . getElementById ('ShipsForSelection') . add (new Option ('none', 'none'));
	for (var race in galaxy . races) {
		for (var ship in galaxy . races [race] . ships) {
			document . getElementById ('ShipsForSelection') . add (new Option (`${race}: ${ship}`, ship));
		}
	}
	// document . getElementById ('GameStatus') . innerHTML = `Phase: ${galaxy . Phase}; Turn: ${galaxy . Turns [0] || 'none'}; TL: ${galaxy . TechnologyLevel};`;
	UpdateShipSelectDiv ();
	UpdateCombatPanel ();
	switch (galaxy . Phase) {
	case 'build':
		document . getElementById ('BuildPanel') . style . visibility = 'visible';
		document . getElementById ('CombatPanel') . style . visibility = 'hidden';
		break;
	case 'move':
		document . getElementById ('BuildPanel') . style . visibility = 'hidden';
		document . getElementById ('CombatPanel') . style . visibility = 'hidden';
		break;
	case 'combat':
		document . getElementById ('BuildPanel') . style . visibility = 'hidden';
		document . getElementById ('CombatPanel') . style . visibility = 'visible';
		break;
	case 'rearrange':
		document . getElementById ('BuildPanel') . style . visibility = 'hidden';
		document . getElementById ('CombatPanel') . style . visibility = 'hidden';
		break;
	default:
		document . getElementById ('BuildPanel') . style . visibility = 'hidden';
		document . getElementById ('CombatPanel') . style . visibility = 'hidden';
		break;
	}
};

var BuildShipReset = function () {
	document . getElementById ('BuildWarpGenerator') . checked = false;
	document . getElementById ('BuildRepairBay') . checked = false;
	document . getElementById ('BuildPowerDrive') . value = 0;
	document . getElementById ('BuildBeams') . value = 0;
	document . getElementById ('BuildShields') . value = 0;
	document . getElementById ('BuildECM') . value = 0;
	document . getElementById ('BuildTubes') . value = 0;
	document . getElementById ('BuildMissiles') . value = 0;
	document . getElementById ('BuildArmor') . value = 0;
	document . getElementById ('BuildCannons') . value = 0;
	document . getElementById ('BuildShells') . value = 0;
	document . getElementById ('BuildBays') . value = 0;
	document . getElementById ('BuildHolds') . value = 0;
};

var BuildShip = function () {
	var location = document . getElementById ('BuildLocations') . value;
	var ship = galaxy . CreateShip (document . getElementById ('BuildLocations') . value);
	if (ship === null) return null;
	if (document . getElementById ('BuildWarpGenerator') . checked) ship . WarpGenerator ();
	if (document . getElementById ('BuildRepairBay') . checked) ship . RepairBay ();
	var PowerDrive = Number (document . getElementById ('BuildPowerDrive') . value); if (PowerDrive > 0) ship . PowerDrive (PowerDrive);
	var Beams = Number (document . getElementById ('BuildBeams') . value); if (Beams > 0) ship . Beams (Beams);
	var Shields = Number (document . getElementById ('BuildShields') . value); if (Shields > 0) ship . Shields (Shields);
	var ECM = Number (document . getElementById ('BuildECM') . value); if (ECM > 0) ship . ECM (ECM);
	var Tubes = Number (document . getElementById ('BuildTubes') . value); if (Tubes > 0) ship . Tubes (Tubes);
	var Missiles = Number (document . getElementById ('BuildMissiles') . value); if (Missiles > 0) ship . Missiles (Missiles);
	var Armor = Number (document . getElementById ('BuildArmor') . value); if (Armor > 0) ship . Armor (Armor);
	var Cannons = Number (document . getElementById ('BuildCannons') . value); if (Cannons > 0) ship . Cannons (Cannons);
	var Shells = Number (document . getElementById ('BuildShells') . value); if (Shells > 0) ship . Shells (Shells);
	var Bays = Number (document . getElementById ('BuildBays') . value); if (Bays > 0) ship . Bays (Bays);
	var Holds = Number (document . getElementById ('BuildHolds') . value); if (Holds > 0) ship . Holds (Holds);
	// console . log (ship);
	ShipSelect (ship . ship . name);
	return ship;
};

var canvas = document . getElementById ('canvas');
var ctx = canvas . getContext ('2d');

var GetName = function (names) {return names . splice (Math . floor (Math . random () * names . length), 1) [0];};
var pmod = function (p, mod) {if (p >= 0) return p % mod; while (p < 0) p += mod; return p;};

var GenerateLocation = function (x, y) {return {x: Math . floor (Math . random () * x), y: Math . floor (Math . random () * y)};};

var Galaxy = function (x, y) {
	this . names = [];
	for (var name of Galaxy . prototype . names) this . names . push (name);
	this . constellations = [];
	for (var name of Galaxy . prototype . constellations) this . constellations . push (name);
	this . size = {width: x, height: y, radius: 32};
	var factor = Math . pow (3, 0.5);
	var left = this . size . height * this . size . radius; var right = this . size . width * factor * this . size . radius;
	var together = left + right;
	var margin = (window . innerWidth - together) * 0.5;
	var height = this . size . radius * this . size . height * 1.5;
	// console . log (left, right, together, window . innerWidth, margin);
	this . shift = {x: margin + left - this . size . radius * 2 + factor * 0.5 * this . size . radius - this . size . radius * 0.5,
		y: (window . innerHeight - height - this . size . radius * 0.5) * 0.5};
	var t = Math . random ();
	var NumberOfStars = Math . floor (x * y * (1.1 * t + 0.9 * (1 - t)) / 12);
	// console . log (NumberOfStars);
	this . stars = {};
	var economies = [0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 5, 5];
	for (var ind = 0; ind < NumberOfStars; ind ++) {
		var location = GenerateLocation (x, y);
		while (this . StarAround (location . x, location . y) !== null) location = GenerateLocation (x, y);
		this . stars [GetName (this . names)] = {location: location, economy: economies [Math . floor (Math . random () * economies . length)]};
	}
	this . warps = [];
	for (var star in this . stars) {
		var destinations = []
		for (var ind in this . stars) {
			if (star !== ind) destinations . push ({star: ind, distance: this . distance (star, ind)});
		}
		destinations . sort (function (a, b) {return a . distance < b . distance ? -1 : a . distance > b . distance ? 1 : 0;});
		for (var sub = 0; sub < 4 && sub < destinations . length; sub ++)
			if (Math . random () < 0.25) this . warps . push ({from: star, to: destinations [sub] . star});
	}
	this . races = {};
	this . TechnologyLevel = 0;
	this . TechnologyStep = 6;
	this . Phase = 'build';
	this . Turns = [];
	this . SelectedShip = null;
	this . CombatLocation = null;
	this . CombatShip = null;
	this . Orders = {};
};

Galaxy . prototype . names = ["Acamar", "Achernar", "Achird", "Acrux", "Acubens", "Adara", "Adhafera", "Adhil", "Agena", "Ain al Rami", "Ain", "Al Anz", "Al Kalb al Rai", "Al Minliar al Asad", "Al Minliar al Shuja", "Aladfar", "Alathfar", "Albaldah", "Albali", "Albireo", "Alchiba", "Alcor", "Alcyone", "Aldebaran", "Alderamin", "Aldhibah", "Alfecca Meridiana", "Alfirk", "Agenib", "Aalgiea", "Algol", "Algorab", "Alhena", "Alioth", "Alkaid", "Alkalurops", "Alkes", "Alkurhah", "Almaak", "Alnair", "Alnath", "Alnilam", "Alnitak", "Alniyat", "Alphard", "Alphekka", "Alpheratz", "Alrai", "Alrisha", "Alsafi", "Alsciaukat", "Alshain", "Alshat", "Alsuhail", "Altair", "Altarf", "Alterf", "Aludra", "Alula Australis", "Alula Borealis", "Alya", "Alzirr", "Ancha", "Angetenar", "Ankaa", "Anser", "Antares", "Arcturus", "Arkab Posterior", "Arkab Prior", "Arneb", "Arrakis", "Ascella", "Asellus Australis", "Asellus Borealis", "Asellus Primus", "Asellus Secondus", "Asellus Tertius", "Asterope", "Atik", "Atlas", "Auva", "Avior", "Azelfafage", "Azha", "Azmidiske", "Baham", "Baten Kaitos", "Becrux", "Beid", "Bellatrix", "Betelgeuse", "Botein", "Brachium", "Canopus", "Capella", "Caph", "Castor", "Cebalrai", "Celaeno", "Chara", "Chort", "Cor Caroli", "Cursa", "Dabih", "Deneb Algedi", "Deneb Dulfim", "Deneb el Okab", "Deneb Kaitos Shemali", "Deneb", "Denebola", "Dheneb", "Diadem", "Diphda", "Dschubba", "Dsiban", "Dubhe", "Ed Asich", "Electra", "Elnath", "Enif", "Etamin", "Formalhaut", "Fornacis", "Fum al Samakah", "Furud", "Gacrux", "Gianfar", "Gienah Cygni", "Gienah Ghurab", "Gomeisa", "Gorgonea Quarta", "Gorgonea Secunda", "Gorgonea Tertia", "Graffias", "Grafias", "Grumium", "Hadar", "Haedi", "Hamal", "Hassaleh", "Head of Hydrus", "Heze", "Hoedus II", "Homam", "Hyadum I", "Hyadum II", "Izar", "Jabbah", "Kaffaljidhma", "Kajam", "Kaus Australis", "Kaus Borealis", "Kaus Meridionalis", "Keid", "Kitalpha", "Kocab", "Kornephoros", "Kraz", "Kuma", "Lesath", "Maasym", "Maia", "Marfak", "Marfic", "Marfik", "Markab", "Matar", "Mebsuta", "Megrez", "Meissa", "Mekbuda", "Menkalinan", "Menkar", "Menkent", "Menkib", "Merak", "Merga", "Merope", "Mesarthim", "Metallah", "Miaplacidus", "Minkar", "Mintaka", "Mira", "Mirach", "Miram", "Mirphak", "Mizar", "Mufrid", "Muliphen", "Murzim", "Muscida", "Nair al Saif", "Naos", "Nash", "Nashira", "Nekkar", "Nihal", "Nodus Secundus", "Nunki", "Nusakan", "Peacock", "Phad", "Phaet", "Pherkad Minor", "Pherkad", "Pleione", "Polaris Australis", "Polaris", "Pollux", "Porrima", "Praecipua", "Prima Giedi", "Procyon", "Propus", "Rana", "Ras Elased Australis", "Ras Elased Borealis", "Rasalgethi", "Rasalhague", "Rastaban", "Regulus", "Rigel Kentaurus", "Rigel", "Rijl al Awwa", "Rotanev", "Ruchba", "Ruchbah", "Rukbat", "Sabik", "Sadalachbia", "Sadalmelik", "Sadalsuud", "Sadr", "Saiph", "Salm", "Sargas", "Sarin", "Sceptrum", "Scheat", "Secunda Giedi", "Segin", "Seginus", "Sham", "Sharatan", "Shaula", "Sheidr", "Sheliak", "Sirius", "Situla", "Skat", "Spica", "Sterope II", "Sualocin", "Subra", "Suhail al Muhlif", "Sulafat", "Syrma", "Tabit", "Talitha", "Tania Australis", "Tania Borealis", "Tarazed", "Taygeta", "Tegmen", "Tejat Posterior", "Terebellum", "Thabit", "Theemim", "Thuban", "Torcularis Septentrionalis", "Turais", "Tyl", "Unukalhai", "Vega", "Vindemiatrix", "Wasat", "Wezen", "Wezn", "Yed Posterior", "Yed Prior", "Yildun", "Zaniah", "Zaurak", "Zavijah", "Zibal", "Zosma", "Zuben Elakrab", "Zuben Elakribi", "Zuben Elgenubi", "Zuben Elschemali"];

Galaxy . prototype . constellations = ["Andromeda", "Antlia", "Apus", "Aquarius", "Aquila", "Ara", "Aries", "Auriga", "Boötes", "Caelum", "Camelopardalis", "Cancer", "Canes Venatici", "Canis Major", "Canis Minor", "Capricornus", "Carina", "Cassiopeia", "Centaurus", "Cepheus", "Cetus", "Chamaeleon", "Circinus", "Columba", "Coma Berenices", "Corona Austrina", "Corona Borealis", "Corvus", "Crater", "Crux", "Cygnus", "Delphinus", "Dorado", "Draco", "Equuleus", "Eridanus", "Fornax", "Gemini", "Grus", "Hercules", "Horologium", "Hydra", "Hydrus", "Indus", "Lacerta", "Leo", "Leo Minor", "Lepus", "Libra", "Lupus", "Lynx", "Lyra", "Mensa", "Microscopium", "Monoceros", "Musca", "Norma", "Octans", "Ophiuchus", "Orion", "Pavo", "Pegasus", "Perseus", "Phoenix", "Pictor", "Pisces", "Piscis Austrinus", "Puppis", "Pyxis", "Reticulum", "Sagitta", "Sagittarius", "Scorpius", "Sculptor", "Scutum", "Serpens", "Sextans", "Taurus", "Telescopium", "Triangulum", "Triangulum Australe", "Tucana", "Ursa Major", "Ursa Minor", "Vela", "Virgo", "Volans", "Vulpecula"];

var Icons = {};
var In = ['g1.png', 'g2.png', 'g3.png', 'g4.png', 'g5.png', 'g6.png', 'g7.png', 'g8.png', 'g9.png',
		'g11.png', 'g12.png', 'g13.png', 'g14.png', 'g15.png', 'g16.png', 'g17.png', 'g18.png', 'g19.png',
		's1.png', 's2.png', 's3.png', 's4.png', 's5.png', 's6.png', 's7.png', 's8.png', 's9.png',
		's10.png', 's11.png', 's12.png', 's13.png', 's14.png', 's15.png', 's16.png', 's17.png', 's18.png',
		's21.png', 's22.png', 's23.png', 's24.png', 's25.png', 's26.png', 's27.png', 's28.png', 's29.png',
		's30.png', 's31.png', 's32.png', 's33.png', 's34.png', 's35.png', 's36.png', 's37.png', 's38.png'
	];
for (var name of In) {Icons [name] = new Image (); Icons [name] . src = name;}

Galaxy . prototype . store = function () {localStorage . setItem ('galaxy', JSON . stringify (this));};
Galaxy . prototype . restore = function () {
	var json = localStorage . getItem ('galaxy');
	if (json === null) return;
	json = JSON . parse (json);
	for (var key in json) this [key] = json [key];
	SelectedShip = null; if (this . SelectedShip) SelectedShip = this . ShipSelect (this . SelectedShip);
};

Galaxy . prototype . CreateRace = function (name, base, colour) {
	if (this . races [name] !== undefined) {alert (`Race ${name} already exists.`); return;}
	for (var race in this . races) {
		// console . log (race, this . races [race]);
		if (this . races [race] . colour === colour) {alert (`Colour ${colour} already taken.`); return;}
		if (this . races [race] . bases [base] !== undefined) {alert (`Star ${base} already taken.`); return;}
	}
	this . races [name] = {colour: colour, bases: {}};
	this . races [name] . bases [base] = {BuildPoints: 20, construction: 30, race: name, colour: colour};
	this . races [name] . ships = {};
	// this . stars [base] . economy = 5;
	this . Turns . push (name);
};

Galaxy . prototype . LoadBuildPoints = function (race, ship, bp) {
	if (this . Phase !== 'build') return;
	ship = this . races [race] . ships [ship];
	var base = this . races [race] . bases [ship . location];
	if (bp > 0 && base && base . BuildPoints >= bp && ship . Holds >= ship . BuildPoints + bp) {base . BuildPoints -= bp; ship . BuildPoints += bp; return;}
	if (bp < 0) {
		bp = - bp;
		if (ship . BuildPoints < bp) return;
		if (base) {
			if (base . construction >= 30) base . BuildPoints += bp; else base . construction += bp;
		} else {
			this . races [race] . bases [ship . location] = {BuildPoints: 0, construction: bp, race: race, colour: ship . colour};
		}
		ship . BuildPoints -= bp;
	}
};

Galaxy . prototype . StarAt = function (x, y) {
	for (star of Object . keys (this . stars)) {
		var location = this . stars [star] . location;
		if (location . x === x && location . y === y) return star;
	}
	return null;
};

Galaxy . prototype . StarAround = function (x, y) {
	var star = this . StarAt (x, y); if (star) return star;
	star = this . StarAt (x, pmod (y + 1, this . size . height)); if (star) return star;
	star = this . StarAt (pmod (x + 1, this . size . width), y); if (star) return star;
	star = this . StarAt (pmod (x + 1, this . size . width), pmod (y + 1, this . size . height)); if (star) return star;
	star = this . StarAt (x, pmod (y - 1, this . size . height)); if (star) return star;
	star = this . StarAt (pmod (x - 1, this . size . width), y); if (star) return star;
	star = this . StarAt (pmod (x - 1, this . size . width), pmod (y - 1, this . size . height)); if (star) return star;
	return null;
};

Galaxy . prototype . CombatAt = function (location) {
	var races = [];
	for (var race in this . races) {
		var Race = this . races [race];
		for (var ship in Race . ships) {
			var Ship = Race . ships [ship];
			if (Ship . location === location && races . indexOf (Ship . race) < 0) races . push (Ship . race);
		}
	}
	return races . length > 1;
};

Galaxy . prototype . Combats = function () {
	var locations = [];
	for (var star in this . stars) {
		if (this . CombatAt (star)) locations . push (star);
	}
	return locations;
};

Galaxy . prototype . ResetOrders = function () {
	var combats = this . Combats ();
	// console . log (combats);
	for (var location of combats) {
		// console . log (location);
		for (var race in this . races) {
			var Race = this . races [race];
			for (var ship in Race . ships) {
				var Ship = Race . ships [ship];
				if (Ship . location === location) {
					this . Orders [ship] = {
						race: race, ship: ship, Strategy: 'DODGE', PowerDrive: 0, Target: null,
						Beams: 0, Shields: 0, Tubes: [], Bays: [], ECM: 0, Cannons: []
					};
					for (var tube = 0; tube < Ship . Tubes; tube ++) this . Orders [ship] . Tubes . push ({Target: null, PowerDrive: 0});
					for (var cannon = 0; cannon < Ship . Cannons; cannon ++) this . Orders [ship] . Cannons . push ({Target: null, Shells: 1});
					for (var bay = 0; bay < Ship . Bays . length; bay ++) this . Orders [ship] . Bays . push (null);
				}
			}
		}
	}
};

var distance = function (dx) {
	if (dx . x >= 0 && dx . y >= 0) return Math . max (dx . x, dx . y);
	if (dx . x <= 0 && dx . y <= 0) return Math . max (- dx . x, - dx . y);
	return Math . abs (dx . x) + Math . abs (dx . y);
};

Galaxy . prototype . distance = function (from, to) {
	if (typeof from === 'string') from = {x: this . stars [from] . location . x, y: this . stars [from] . location . y};
	if (typeof to === 'string') to = {x: this . stars [to] . location . x, y: this . stars [to] . location . y};
	var dx = {x: to . x - from . x, y: to . y - from . y};
	var d1 = distance (dx);
	var d2 = distance ({x: dx . x - this . size . width, y: dx . y});
	var d3 = distance ({x: dx . x + this . size . width, y: dx . y});
	var d4 = distance ({x: dx . x, y: dx . y - this . size . height});
	var d5 = distance ({x: dx . x, y: dx . y + this . size . height});
	var d6 = distance ({x: dx . x - this . size . width, y: dx . y - this . size . height});
	var d7 = distance ({x: dx . x - this . size . width, y: dx . y + this . size . height});
	var d8 = distance ({x: dx . x + this . size . width, y: dx . y - this . size . height});
	var d9 = distance ({x: dx . x + this . size . width, y: dx . y + this . size . height});
	return Math . min (d1, d2, d3, d4, d5, d6, d7, d8, d9);
};

Galaxy . prototype . RawDistance = function (from, to) {
	var dx = {x: to . x - from . x, y: to . y - from . y};
	var d1 = distance (dx);
	var d2 = distance ({x: dx . x - this . size . width, y: dx . y});
	var d3 = distance ({x: dx . x + this . size . width, y: dx . y});
	var d4 = distance ({x: dx . x, y: dx . y - this . size . height});
	var d5 = distance ({x: dx . x, y: dx . y + this . size . height});
	var d6 = distance ({x: dx . x - this . size . width, y: dx . y - this . size . height});
	var d7 = distance ({x: dx . x - this . size . width, y: dx . y + this . size . height});
	var d8 = distance ({x: dx . x + this . size . width, y: dx . y - this . size . height});
	var d9 = distance ({x: dx . x + this . size . width, y: dx . y + this . size . height});
	return Math . min (d1, d2, d3, d4, d5, d6, d7, d8, d9);
};

var GetName = function (names) {return names . splice (Math . floor (Math . random () * names . length), 1) [0];};

Galaxy . prototype . Collect = function () {
	if (this . Phase === 'build') return; this . Phase = 'build';
	this . Turns . shift (galaxy . races);
	if (this . Turns . length < 1) {
		var races = Object . keys (this . races);
		while (races . length > 0) this . Turns . push (races . splice (Math . floor (Math . random () * races . length), 1) [0]);
		this . TechnologyLevel ++;
	}
	if (this . TechnologyLevel < 1) return;
	for (var star in this . stars) {
		var Star = this . stars [star];
		var Base = this . BaseAt (Star . location . x, Star . location . y);
		if (Base && Base . race === this . Turns [0] && Base . construction >= 30) Base . BuildPoints += Star . economy * 2;
		else {
			var Ships = this . ShipsAt (Star . location . x, Star . location . y);
			var BuildPoints = Star . economy;
			for (var ind = 0; BuildPoints > 0 && ind < Ships . length; ind ++) {
				var Ship = Ships [ind];
				if (Ship . race === this . Turns [0]) {
					var capacity = Ship . Holds - Ship . BuildPoints;
					var amount = BuildPoints > capacity ? capacity : BuildPoints;
					BuildPoints -= amount;
					Ship . BuildPoints += amount;
					// console . log (Ship . name, Ship . Holds, Ship . BuildPoints);
				}
			}
		}
	}
};

Galaxy . prototype . Combat = function (CombatLocations) {
	for (var race in this . races) {for (var ship in this . races [race] . ships) {this . races [race] . ships [ship] . move = 0;}}
	if (CombatLocations . length < 1) return;
	if (this . Phase !== 'move') return; this . Phase = 'combat';
	this . CombatLocation = CombatLocations [0];
	this . ResetOrders ();
};

Galaxy . prototype . ShipSelect = function (name) {
	for (var race in this . races) {
		for (var ship in this . races [race] . ships) {
			if (ship === name) {this . SelectedShip = name; return new Ship (this, this . races [race] . ships [ship]);}
		}
	}
	this . SelectedShip = null;
	return null;
};

var ShipSelect = function (name) {SelectedShip = galaxy . ShipSelect (name); repaint ();};

Galaxy . prototype . ReMoveShips = function () {
	if (this . Phase === 'move') return; this . Phase = 'move';
	if (this . Turns . length < 1) return this;
	for (var ship in this . races [this . Turns [0]] . ships) {
		var Ship = this . races [this . Turns [0]] . ships [ship];
		if (Ship . WarpGenerator) Ship . move = Ship . PowerDrive;
	}
};

Galaxy . prototype . Next = function () {
	if (this . Turns . length < 1) return;
	switch (this . Phase) {
	case 'build': this . ReMoveShips (); break;
	case 'move':
		var combats = this . Combats ();
		if (combats . length > 0) this . Combat (combats);
		else this . Phase = 'rearrange';
		break;
	case 'combat':
		if (this . Combats () . length > 0) break;
		this . Phase = 'rearrange';
		break;
	case 'rearrange': this . Collect (); break;
	default: break;
	}
};

Galaxy . prototype . ColourForStar = function (star) {
	for (var race in this . races) {
		var Race = this . races [race];
		for (var base in Race . bases) {
			if (base === star) return Race . colour;
		}
	}
	return '#000033';
};

Galaxy . prototype . draw = function () {
	var radius = this . size . radius;
	var size = radius + radius;
	var hh = Math . pow (3, 0.5) * radius / 2;
	var hhh = hh + hh;
	var ll = radius * 1.5;
	var l = radius * 0.5;
	var hhx = hh * 1;
	ctx . strokeStyle = 'gray';
	// for (var sub = - Math . floor (this . size . height * 0.5); sub < Math . floor (this . size . height * 1.5); sub ++) {
	for (var sub = 0; sub < this . size . height; sub ++) {
		// for (var ind = - Math . floor (this . size . width * 0.5); ind < Math . floor (this . size . width * 1.5); ind ++) {
		for (var ind = 0; ind < this . size . width; ind ++) {
			ctx . beginPath ();
			ctx . moveTo (this . shift . x - sub * hh + radius + ind * hhh + hhx * 0.9, this . shift . y + sub * ll + radius - l);
			ctx . lineTo (this . shift . x - sub * hh + radius + ind * hhh + hhx * 0.9, this . shift . y + sub * ll + radius + l);
			ctx . lineTo (this . shift . x - sub * hh + radius + ind * hhh, this . shift . y + sub * ll + radius + radius * 0.9);
			ctx . lineTo (this . shift . x - sub * hh + radius + ind * hhh - hhx * 0.9, this . shift . y + sub * ll + radius + l);
			ctx . lineTo (this . shift . x - sub * hh + radius + ind * hhh - hhx * 0.9, this . shift . y + sub * ll + radius - l);
			ctx . lineTo (this . shift . x - sub * hh + radius + ind * hhh, this . shift . y + sub * ll + radius * 0.1);
			ctx . closePath ();
			// ctx . arc (this . shift . x - sub * hh + radius + ind * hhh, this . shift . y + sub * ll + radius, radius, 0, Math . PI * 2);
			ctx . stroke ();
			var Base = this . BaseOrShipAt (ind, sub);
			if (Base !== null) {
				if (Base . location === undefined || typeof Base . location === 'string') {ctx . fillStyle = Base . colour; ctx . fill ();}
				ctx . fillStyle = 'white'; ctx . textAlign = 'center';
				if (Base . BuildPoints !== undefined && Base . name === undefined)
					ctx . fillText (Base . construction >= 30 ? `[${Base . BuildPoints}]` : `<${Base . construction}>`,
						this . shift . x + ind * hhh - sub * hh + radius,
						this . shift . y + sub * ll + radius - 12);
			}
		}
	}
	ctx . strokeStyle = 'blue';
	for (var ind in this . warps) {
		var warp = this . warps [ind];
		var from = this . stars [warp . from] . location; var to = this . stars [warp . to] . location; var toa = [];
		toa . push (to);
		toa . push ({x: to . x - this . size . width, y: to . y});
		toa . push ({x: to . x - this . size . width, y: to . y - this . size . height});
		toa . push ({x: to . x, y: to . y - this . size . height});
		toa . push ({x: to . x + this . size . width, y: to . y - this . size . height});
		toa . push ({x: to . x + this . size . width, y: to . y});
		toa . push ({x: to . x + this . size . width, y: to . y + this . size . height});
		toa . push ({x: to . x, y: to . y + this . size . height});
		toa . push ({x: to . x - this . size . width, y: to . y + this . size . height});
		for (var t in toa) toa [t] . distance = distance ({x: toa [t] . x - from . x, y: toa [t] . y - from . y});
		toa . sort (function (a, b) {return a . distance < b . distance ? -1 : a . distance > b . distance ? 1 : 0;});
		to = toa [0];
		// console . log (warp, from, toa);
		ctx . beginPath ();
		ctx . moveTo (this . shift . x + from . x * hhh - from . y * hh + radius, this . shift . y + from . y * ll + radius);
		ctx . lineTo (this . shift . x + to . x * hhh - to . y * hh + radius, this . shift . y + to . y * ll + radius);
		ctx . stroke ();
		// console . log (from, to);
	}
	for (var race in this . races) {
		for (var ship in this . races [race] . ships) {
			var s = this . races [race] . ships [ship];
			var st = s . location;
			if (typeof st === 'string') {st = this . stars [st]; if (st) st = st . location;}
			// var st = this . stars [s . location] . location;
			if (st) {
				ctx . save ();
				ctx . translate (Icons [s . icon] . width * -0.25, Icons [s . icon] . height * -0.25);
				ctx . translate (this . shift . x, this . shift . y);
				ctx . translate (hh, radius);
				ctx . translate (st . x * hhh - st . y * hh, st . y * ll);
				ctx . scale (0.5, 0.5);
				ctx . drawImage (Icons [s . icon], 0, 0);
				ctx . restore ();
			}
		}
	}
	ctx . textAlign = 'center';
	ctx . fillStyle = 'white';
	for (var star in this . stars) {
		var st = this . stars [star];
		var dx = this . shift . x + st . location . x * hhh - st . location . y * hh + radius;
		var dy = this . shift . y + st . location . y * ll + radius;
		var W = ctx . measureText (star) . width * 0.5;
		ctx . beginPath ();
		ctx . moveTo (dx - W, dy - 10); ctx . lineTo (dx + W, dy - 10); ctx . lineTo (dx + W, dy + 2); ctx . lineTo (dx - W, dy + 2);
		ctx . fillStyle = this . ColourForStar (star); ctx . fill ();
		ctx . fillStyle = 'white';
		ctx . fillText (star, dx, dy);
		ctx . fillText (star, dx - this . size . width * hhh, dy);
		ctx . fillText (star, dx + this . size . width * hhh, dy);
		ctx . fillText (star, dx - this . size . height * hh, dy + this . size . height * ll);
		ctx . fillText (star, dx + this . size . height * hh, dy - this . size . height * ll);
		ctx . fillText (star, dx - this . size . width * hhh - this . size . height * hh, dy + this . size . height * ll);
		ctx . fillText (star, dx + this . size . width * hhh - this . size . height * hh, dy + this . size . height * ll);
		ctx . fillText (star, dx - this . size . width * hhh + this . size . height * hh, dy - this . size . height * ll);
		ctx . fillText (star, dx + this . size . width * hhh + this . size . height * hh, dy - this . size . height * ll);
		ctx . fillText (st . economy, dx, dy + 12);
	}
	for (var star in this . stars) {
		var location = this . stars [star] . location;
		var ships = this . ShipsAt (location . x, location . y);
		var races = [];
		for (var ind in ships) if (races . indexOf (ships [ind] . race) < 0) races . push (ships [ind] . race);
		if (races . length > 1) {
			ctx . strokeStyle = 'red';
			ctx . beginPath ();
			ctx . arc (
				this . shift . x + this . size . radius + location . x * hhh - location . y * hh,
				this . shift . y + this . size . radius + location . y * ll,
				this . size . radius * 1.5, 0, Math . PI * 2);
			ctx . stroke ();
		}
	}
	for (var race in this . races) {
		var Race = this . races [race];
		for (var ship in Race . ships) {
			if (ship === this . SelectedShip) {
				ctx . strokeStyle = 'blue';
				var location = Race . ships [ship] . location;
				if (typeof location === 'string') {
					location = this . stars [location];
					if (location) location = location . location;
					else {
						location = Race . ships [Race . ships [ship] . location] . location;
						if (typeof location === 'string') location = this . stars [location] . location;
					}
				}
				ctx . strokeStyle = 'blue';
				ctx . beginPath ();
				ctx . arc (
					this . shift . x + this . size . radius + location . x * hhh - location . y * hh,
					this . shift . y + this . size . radius + location . y * ll,
					this . size . radius * 1.25, 0, Math . PI * 2);
				ctx . stroke ();
			}
		}
	}
};

Galaxy . prototype . RaceFromBase = function (base) {
	for (var race in this . races) {
		for (var b in this . races [race] . bases) {
			if (b === base) return race;
		}
	}
	return null;
};

Galaxy . prototype . BaseAt = function (x, y) {
	for (var race in this . races) {
		for (var base in this . races [race] . bases) {
			var star = this . stars [base];
			if (star . location . x === x && star . location . y === y) return this . races [race] . bases [base];
		}
	}
	return null;
};

Galaxy . prototype . ShipAt = function (x, y) {
	for (var race in this . races) {
		var r = this . races [race];
		for (var ship in r . ships) {
			var s = r . ships [ship];
			var st = s . location;
			if (typeof st === 'string') {st = this . stars [st]; if (st) st = st . location;}
			if (st && st . x === x && st . y === y) return s;
		}
	}
	return null;
};

Galaxy . prototype . ShipsAt = function (x, y) {
	var ships = [];
	for (var race in this . races) {
		var r = this . races [race];
		for (var ship in r . ships) {
			var s = r . ships [ship];
			var st = s . location;
			if (typeof st === 'string') {st = this . stars [st]; if (st) st = st . location;}
			if (st && st . x === x && st . y === y) ships . push (s);
		}
	}
	return ships;
};

Galaxy . prototype . Ship = function (name) {
	for (var race in galaxy . races) {var Race = galaxy . races [race]; for (var ship in Race . ships) if (ship === name) return Race . ships [ship];}
};

Galaxy . prototype . BaseOrShipAt = function (x, y) {return this . BaseAt (x, y) || this . ShipAt (x, y);};

var Ship = function (galaxy, ship) {this . galaxy = galaxy; this . ship = ship; this . source = null; this . SourceName = null;};
Ship . prototype . move = function (target) {
	this . source = null; this . SourceName = null;
	if (this . ship . move < 1) return this;
	if (typeof this . ship . location === 'string') {
		var location = this . galaxy . stars [this . ship . location] . location;
		var ships = this . galaxy . ShipsAt (location . x, location . y);
		for (var ship in ships) {
			if (ships [ship] . race !== this . ship . race) {console . log (`${ships [ship] . race} is present.`); return this;}
		}
	}
	if (typeof target === 'string') {
		for (var ind in this . galaxy . warps) {
			var warp = this . galaxy . warps [ind];
			if ((warp . from === this . ship . location && warp . to === target) ||
				(warp . to === this . ship . location && warp . from === target)) {
				this . ship . location = target; this . ship . move --; return this;
			}
		}
	} else {
		var st = this . ship . location;
		if (typeof st === 'string') st = {x: this . galaxy . stars [st] . location . x, y: this . galaxy . stars [st] . location . y};
		if (target . x === 0 && target . y === 0) return this;
		if (target . x > 1 || target . x < -1 || target . y > 1 || target . y < -1) return this;
		if (target . x + target . y === 0 && target . x !== target . y) return this;
		st . x = pmod (st . x + target . x, this . galaxy . size . width); st . y = pmod (st . y + target . y, this . galaxy . size . height);
		this . ship . location = st;
		this . ship . move --;
		for (var star in this . galaxy . stars) {
			if (this . galaxy . stars [star] . location . x === st . x && this . galaxy . stars [star] . location . y === st . y)
				this . ship . location = star;
		}
		return this;
	}
	return this;
};
Ship . prototype . CanRepair = function () {
	if (this . galaxy . Phase !== 'build') return false;
	var location = this . ship . location;
	if (typeof location !== 'string') return false;
	var race = this . ship . race;
	var Base = this . galaxy . races [race] . bases [location];
	if (Base && Base . construction >= 30) return location;
	for (var ship in this . galaxy . races [race] . ships) {
		var Ship = this . galaxy . races [race] . ships [ship];
		if (Ship . location === location && Ship . Holds > 0) {
			for (var rship in this . galaxy . races [race] . ships) {
				var RShip = this . galaxy . races [race] . ships [rship];
				if (RShip . location === location && RShip . RepairBay) return Ship . name;
			}
		}
	}
	location = this . galaxy . races [race] . ships [location];
	if (location) location = location . location;
	Base = this . galaxy . races [race] . bases [location];
	if (Base && Base . construction >= 30) return location;
	for (var ship in this . galaxy . races [race] . ships) {
		var Ship = this . galaxy . races [race] . ships [ship];
		if (Ship . location === location && Ship . Holds > 0) {
			for (var rship in this . galaxy . races [race] . ships) {
				var RShip = this . galaxy . races [race] . ships [rship];
				if (RShip . location === location && RShip . RepairBay) return Ship . name;
			}
		}
	}
	return false;
};
Ship . prototype . Source = function (ship) {
	this . source = null; this . SourceName = null;
	var Base = this . galaxy . races [this . ship . race] . bases [this . ship . location];
	if (Base && Base . construction >= 30) {this . source = Base; this . SourceName = this . ship . location; return this;}
	var Ship = this . galaxy . races [this . ship . race] . ships [ship];
	if (Ship && this . ship . location === Ship . location && Ship . BuildPoints > 0) {this . source = Ship; this . SourceName = Ship . name; return this;}
	var Carrier = this . galaxy . races [this . ship . race] . ships [this . ship . location];
	if (Ship && Carrier && Carrier . location === Ship . location && Ship . BuildPoints > 0) {this . source = Ship; this . SourceName = Ship . name; return this;}
	return this;
};
Ship . prototype . PowerDrive = function (pd) {
	if (this . source === null || this . source . BuildPoints < pd) return this;
	this . source . BuildPoints -= pd; this . ship . PowerDrive += pd; this . ship . original . PowerDrive += pd; return this;
};
Ship . prototype . WarpGenerator = function () {
	if (this . source === null || this . source . BuildPoints < 5) return this;
	this . ship . icon = RandomWarpIcon ();
	this . source . BuildPoints -= 5; this . ship . WarpGenerator = true; this . ship . original . WarpGenerator = true; return this;
};
Ship . prototype . Beams = function (pd) {
	if (this . source === null || this . source . BuildPoints < pd) return this;
	this . source . BuildPoints -= pd; this . ship . Beams += pd; this . ship . original . Beams += pd; return this;
};
Ship . prototype . Shields = function (pd) {
	if (this . source === null || this . source . BuildPoints < pd) return this;
	this . source . BuildPoints -= pd; this . ship . Shields += pd; this . ship . original . Shields += pd; return this;
};
Ship . prototype . ECM = function (pd) {
	if (this . source === null || this . source . BuildPoints < pd) return this;
	this . source . BuildPoints -= pd; this . ship . ECM += pd; this . ship . original . ECM += pd; return this;
};
Ship . prototype . Tubes = function (pd) {
	if (this . source === null || this . source . BuildPoints < pd) return this;
	this . source . BuildPoints -= pd; this . ship . Tubes += pd; this . ship . original . Tubes += pd; return this;
};
Ship . prototype . Missiles = function (pd) {
	if (this . source === null || this . source . BuildPoints < pd) return this;
	this . source . BuildPoints -= pd; this . ship . Missiles += pd * 3; this . ship . original . Missiles += pd * 3; return this;
};
Ship . prototype . Armor = function (pd) {
	if (this . source === null || this . source . BuildPoints < pd) return this;
	this . source . BuildPoints -= pd; this . ship . Armor += pd * 2; this . ship . original . Armor += pd * 2; return this;
};
Ship . prototype . Cannons = function (pd) {
	if (this . source === null || this . source . BuildPoints < pd) return this;
	this . source . BuildPoints -= pd; this . ship . Cannons += pd; this . ship . original . Cannons += pd; return this;
};
Ship . prototype . Shells = function (pd) {
	if (this . source === null || this . source . BuildPoints < pd) return this;
	this . source . BuildPoints -= pd; this . ship . Shells += pd * 6; this . ship . original . Shells += pd * 6; return this;
};
Ship . prototype . Bays = function (pd) {
	if (this . source === null || this . source . BuildPoints < pd || ! this . ship . original . WarpGenerator) return this;
	this . source . BuildPoints -= pd; this . ship . original . Bays += pd;
	for (var ind = 0; ind < pd; ind ++) this . ship . Bays . push (null);
	return this;
};
Ship . prototype . Holds = function (pd) {
	if (this . source === null || this . source . BuildPoints < pd || ! this . ship . original . WarpGenerator) return this;
	this . source . BuildPoints -= pd; this . ship . Holds += pd * 10; this . ship . original . Holds += pd * 10; return this;
};
Ship . prototype . RepairBay = function () {
	if (this . source === null || this . source . BuildPoints < 5 || ! this . ship . original . WarpGenerator) return this;
	this . source . BuildPoints -= 5; this . ship . RepairBay = true; this . ship . original . RepairBay = true; return this;
};
Ship . prototype . Icon = function (icon) {this . ship . icon = icon;};
Ship . prototype . Drop = function (bay) {
	if (typeof this . ship . location !== 'string') return this;
	if (this . galaxy . Phase === 'move' && this . ship . move < 1) return this;
	var ship = this . ship . Bays [bay];
	ship = this . galaxy . races [this . ship . race] . ships [ship];
	ship . location = this . ship . location;
	this . ship . Bays [bay] = null;
	if (this . galaxy . Phase === 'move') this . ship . move --;
	return this;
};
Ship . prototype . Pick = function (ship, bay) {
	if (typeof this . ship . location !== 'string') return this;
	if (this . galaxy . Phase === 'move' && this . ship . move < 1) return this;
	ship = this . galaxy . races [this . ship . race] . ships [ship];
	if (! ship) return this;
	this . ship . Bays [bay] = ship . name;
	ship . location = this . ship . name;
	if (this . galaxy . Phase === 'move') this . ship . move --;
	return this;
};
Ship . prototype . Repair = function (attribute, bp, delta) {
	if (delta === undefined) delta = 1;
	if (! this . source) return this;
	if (this . source . BuildPoints < bp) return this;
	this . ship [attribute] += delta;
	if (this . ship [attribute] > this . ship . original [attribute]) this . ship [attribute] = this . ship . original [attribute];
	this . source . BuildPoints -= bp;
	return this;
};
Ship . prototype . BayRepair = function (ind) {
	if (! this . source) return this;
	if (this . source . BuildPoints < 1) return this;
	if (this . ship . Bays . length <= ind) return this;
	if (this . ship . Bays [ind] !== 'damage') return this;
	this . ship . Bays [ind] = null;
	this . source . BuildPoints --;
	return this;
};

var RandomSystemIcon = function () {
	var s = [
		's1.png', 's2.png', 's3.png', 's4.png', 's5.png', 's6.png', 's7.png', 's8.png', 's9.png',
		's10.png', 's11.png', 's12.png', 's13.png', 's14.png', 's15.png', 's16.png', 's17.png', 's18.png',
		's21.png', 's22.png', 's23.png', 's24.png', 's25.png', 's26.png', 's27.png', 's28.png', 's29.png',
		's30.png', 's31.png', 's32.png', 's33.png', 's34.png', 's35.png', 's36.png', 's37.png', 's38.png'
	];
	return s [Math . floor (Math . random () * s . length)];
};
var RandomWarpIcon = function () {
	var g = [
		'g1.png', 'g2.png', 'g3.png', 'g4.png', 'g5.png', 'g6.png', 'g7.png', 'g8.png', 'g9.png',
		'g11.png', 'g12.png', 'g13.png', 'g14.png', 'g15.png', 'g16.png', 'g17.png', 'g18.png', 'g19.png'
	];
	return g [Math . floor (Math . random () * g . length)];
};
Galaxy . prototype . CreateShip = function (base, name) {
	if (name === undefined) name = GetName (this . constellations);
	var race = this . RaceFromBase (base);
	if (race === null) {alert (`Can not identify race at ${base}.`); return null;}
	if (race !== this . Turns [0]) {alert (`It is now ${this . Turns [0]} turn. Not ${race}.`); return null;}
	if (this . races [race] . bases [base] . construction < 30) {alert (`Base at ${base} incomplete.`); return null;}
	var ship = {
		PowerDrive: 0, WarpGenerator: false, Beams: 0, Shields: 0, ECM: 0, Tubes: 0, Missiles: 0,
		Armor: 0, Cannons: 0, Shells: 0, Bays: [], Holds: 0, RepairBay: false,
		original: {
			PowerDrive: 0, WarpGenerator: false, Beams: 0, Shields: 0, ECM: 0, Tubes: 0, Missiles: 0,
			Armor: 0, Cannons: 0, Shells: 0, Bays: 0, Holds: 0, RepairBay: false},
		location: base, move: 0, name: name, icon: RandomSystemIcon (), TechnologyLevel: this . TechnologyLevel,
		race: race, colour: this . races [race] . colour, BuildPoints: 0};
	this . races [race] . ships [name] = ship;
	return new Ship (this, ship) . Source (base);
};

var repaint = function () {
	canvas . width = window . innerWidth;
	canvas . height = window . innerHeight;
	ctx . save ();
	galaxy . draw ();
	if (Object . keys (galaxy . races) . length > 0) {
		ctx . fillStyle = galaxy . races [galaxy . Turns [0]] . colour;
		ctx . font = '24px arial';
		ctx . textAlign = 'left';
		ctx . fillText (`${galaxy . Turns [0]} ${galaxy . Phase} TL = [${galaxy . TechnologyLevel}]`, 400, 32);
		ctx . restore ();
	}
	RestoreSelects ();
	RefitRaces ();
	// ctx . fillRect (0, 0, canvas . width, canvas . height);
};

var MouseLocation = {x: 0, y: 0};
var dragging = false;

var OnMouseDown = function (e) {
	e . preventDefault ();
	MouseLocation = {x: e . clientX, y: e . clientY};
	dragging = true;
	if (galaxy . Phase === 'move' && SelectedShip) {
		var fraction = Math . pow (3, 0.5);
		var hit = {
			x: 0.5 + (e . clientX - galaxy . shift . x - galaxy . size . radius) / (galaxy . size . radius * fraction),
			y: Math . floor (0.5 + (e . clientY - galaxy . shift . y - galaxy . size . radius) / (galaxy . size . radius * 1.5))
		};
		hit . x = Math . floor (hit . x + hit . y * 0.5);
		var star = galaxy . StarAt (hit . x, hit . y);
		var ShipLocation = SelectedShip . ship . location;
		if (star && typeof ShipLocation === 'string') hit = star;
		if (typeof ShipLocation === 'string') ShipLocation = galaxy . stars [ShipLocation] . location;
		// console . log ('Move', SelectedShip . ship . name, ShipLocation, star, hit);
		if (typeof hit !== 'string' && typeof ShipLocation !== 'string') {hit . x -= ShipLocation . x; hit . y -= ShipLocation . y;}
		SelectedShip . move (hit);
		repaint ();
	}
	return false;
};

var OnMouseUp = function () {dragging = false;};

var OnMouseMove = function (e) {
	if (! dragging) return;
	var point = {x: e . clientX, y: e . clientY};
	var delta = {x: point . x - MouseLocation . x, y: point . y - MouseLocation . y};
	galaxy . shift . x += delta . x; galaxy . shift . y += delta . y;
	// console . log (delta);
	MouseLocation = point;
	repaint ();
};

var RefitRaces = function () {
	var table = '<table><tr><td>RACES:</td>';
	for (var race in galaxy . races) table += `<td bgcolor="${galaxy . races [race] . colour}"><font color="white">${race}</font></td>`;
	table += '</tr></table>';
	document . getElementById ('CreateRaces') . innerHTML = table;
};

for (var ind = 0; ind < Galaxy . prototype . names . length; ind ++) {
	var name = Galaxy . prototype . names [ind];
	var count = 0;
	for (var sub = 0; sub < Galaxy . prototype . names . length; sub ++) {
		if (Galaxy . prototype . names [ind] === Galaxy . prototype . names [sub]) count ++;
	}
	if (count > 1) console . log (Galaxy . prototype . names [ind], count);
}

var galaxy = new Galaxy (28, 14);
// galaxy . restore ();
repaint ();

</script>

</body>
</html>


<meta charset="UTF-8"/>
<html>
	<head>
		<title>Warpwar</title>
	</head>


<body bgcolor="#000033" style="background-size: cover; padding: 0px; margin: 0px;" onresize="javascript: repaint ();">

<div id="BuildPanel" style="position: absolute; left: 8px; top: 8px; border-radius: 8px; padding: 8px; background-color: gold; font-family: arial;">
	<input type="button" value="Build" onclick="javascript: BuildShip (); repaint ();"/>
	<input type="button" value="Reset" onclick="javascript: BuildShipReset ();"/><br/>
	Location:<select id="BuildLocations"></select><br/>
	Warp Generator: <input type="checkbox" id="BuildWarpGenerator"/><br/>
	Power Drive: <input type="number" min="0" value="0" style="width: 5em;" id="BuildPowerDrive"/><br/>
	Beams: <input type="number" min="0" value="0" style="width: 5em;" id="BuildBeams"/><br/>
	Shields: <input type="number" min="0" value="0" style="width: 5em;" id="BuildShields"/><br/>
	Tubes: <input type="number" min="0" value="0" style="width: 5em;" id="BuildTubes"/><br/>
	Missiles: <input type="number" min="0" value="0" style="width: 5em;" id="BuildMissiles"/><br/>
	Bays: <input type="number" min="0" value="0" style="width: 5em;" id="BuildBays"/><br/>
	<hr/>
	Repair Bay: <input type="checkbox" id="BuildRepairBay"/><br/>
	ECM: <input type="number" min="0" value="0" style="width: 5em;" id="BuildECM"/><br/>
	Armor: <input type="number" min="0" value="0" style="width: 5em;" id="BuildArmor"/><br/>
	Cannons: <input type="number" min="0" value="0" style="width: 5em;" id="BuildCannons"/><br/>
	Shells: <input type="number" min="0" value="0" style="width: 5em;" id="BuildShells"/><br/>
	Holds: <input type="number" min="0" value="0" style="width: 5em;" id="BuildHolds"/><br/>
</div>
<div id="CombatPanel" style="position: absolute; left: 8px; top: 8px; border-radius: 8px; padding: 8px; background-color: gold; font-family: arial;">
	<div id="CombatLocationDiv" style="float: left;">sputnik</div>&nbsp;
	<select id="CombatLocation" onchange="javascript: if (this . value !== 'select') {galaxy . CombatLocation = this . value; galaxy . CombatShip = null;} repaint ();"></select>
	<select id="CombatShip" onchange="javascript: if (this . value !== 'select') galaxy . CombatShip = this . value; repaint ();"></select>
	<div id="CombatShipData">
	</div>
</div>
<div id="Combat Result Table" style="position: absolute; right: 512px; top: 8px; border-radius: 8px; padding: 8px; background-color: gold; font-family: arial; visibility: hidden;">
	<table>
		<tr><td><input type="button" value="CLOSE" onclick="javascript: document . getElementById ('Combat Result Table') . style . visibility = 'hidden';"/></td><td><b>DIFF</b></td><td><b>ATTACK</b></td><td><b>DODGE</b></td><td><b>RETREAT</b></td></tr>
		<tr><td colspan="5"><hr/></td></tr>
		<tr><td rowspan="6"><b>ATTACK</b></td><td>-3 or less</td><td></td><td></td><td>ESCAPE</td></tr>
		<tr><td>-2, -1</td><td>HIT</td><td></td><td>ESCAPE</td></tr>
		<tr><td>0, 1</td><td>HIT + 2</td><td></td><td></td></tr>
		<tr><td>2</td><td>HIT + 1</td><td>HIT + 1</td><td></td></tr>
		<tr><td>3, 4</td><td></td><td>HIT</td><td>HIT</td></tr>
		<tr><td>5 or more</td><td></td><td></td><td></td></tr>
		<tr><td colspan="5"><hr/></td></tr>
		<tr><td rowspan="5"><b>DODGE</b></td><td>-4 or less</td><td></td><td></td><td>ESCAPE</td></tr>
		<tr><td>-3, -2</td><td></td><td>HIT</td><td>ESCAPE</td></tr>
		<tr><td>-1, 0</td><td>HIT</td><td>HIT</td><td>ESCAPE</td></tr>
		<tr><td>1, 2</td><td>HIT</td><td></td><td>ESCAPE</td></tr>
		<tr><td>3 or more</td><td></td><td></td><td>ESCAPE</td></tr>
		<tr><td colspan="5"><hr/></td></tr>
		<tr><td rowspan="3"><b>RETREAT</b></td><td>-2 or less</td><td></td><td></td><td>ESCAPE</td></tr>
		<tr><td>-1, 0</td><td>HIT</td><td></td><td>ESCAPE</td></tr>
		<tr><td>1 or more</td><td></td><td></td><td>ESCAPE</td></tr>
		<tr><td colspan="5"><hr/></td></tr>
		<tr><td><b>ESCAPE</b></td><td colspan="4">Needs <b>ESCAPE</b> result from all enemy ships (excluding missiles).</td></tr>
		<tr><td><b>DROP/PICKUP</b></td><td colspan="4">Drive=0, Screens=0, Strategy=(dodge || retreat), no missiles or cannons,<br/>Beams and ECM can be used.</td></tr>
		<tr><td><b>PICKED UP</b></td><td colspan="4">No fire at all. OK to use Shields and ECM.</td></tr>
		<tr><td><b>BEAMS/SHIELDS</b><td colspan="4">Can not be used with missiles or cannons.</td></tr>
	</table>
</div>
<!--<div style="position: absolute; bottom: 8px; left: 8px; border-radius: 8px; padding: 8px; background-color: gold; font-family: arial;">
	<input type="button" value="Collect" onclick="javascript: galaxy . Collect (); repaint ();"/>
	<input type="button" value="ReMove" onclick="javascript: galaxy . ReMoveShips (); repaint ();"/>
	<input type="button" value="Store" onclick="javascript: galaxy . store ();"/>
	<input type="button" value="Restore" onclick="javascript: galaxy . restore (); repaint ();"/>
	<input type="button" value="Next" onclick="javascript: galaxy . Next (); repaint ();"/>
</div>-->
<!--<div id="Ships" style="visibility: hidden; position: absolute; background-color: #44444444; border-radius: 8px; padding: 8px; top: 8px; left: 256px;">
	<img src="g1.png"/><img src="g2.png"/><img src="g3.png"/><img src="g4.png"/><img src="g5.png"/><img src="g6.png"/>
	<img src="g7.png"/><img src="g8.png"/><img src="g9.png"/><br/>
	<img src="s1.png"/><img src="s2.png"/><img src="s3.png"/><img src="s4.png"/><img src="s5.png"/><img src="s6.png"/><img src="s7.png"/>
	<img src="s8.png"/><img src="s9.png"/><br/><img src="s10.png"/><img src="s11.png"/><img src="s12.png"/><img src="s13.png"/>
	<img src="s14.png"/><img src="s15.png"/><img src="s16.png"/><img src="s17.png"/><img src="s18.png"/><br/>
	<img src="g11.png"/><img src="g12.png"/><img src="g13.png"/><img src="g14.png"/><img src="g15.png"/><img src="g16.png"/>
	<img src="g17.png"/><img src="g18.png"/><img src="g19.png"/><br/>
	<img src="s21.png"/><img src="s22.png"/><img src="s23.png"/><img src="s24.png"/><img src="s25.png"/><img src="s26.png"/><img src="s27.png"/>
	<img src="s28.png"/><img src="s29.png"/><br/><img src="s30.png"/><img src="s31.png"/><img src="s32.png"/><img src="s33.png"/>
	<img src="s34.png"/><img src="s35.png"/><img src="s36.png"/><img src="s37.png"/><img src="s38.png"/>
</div>-->

<div id="SelectedShip" style="position: absolute; right: 8px; top: 8px; border-radius: 8px; padding: 8px; background-color: gold; font-family: arial;">
	<select id="ShipsForSelection" onchange="javascript: ShipSelect (this . value);"/></select>
	<div id="ShipData"/></div>
</div>

<div id="JSON" style="position: absolute; left: 256px; top: 208px; padding: 8px; border-radius: 8px; background-color: gold; font-family: arial; visibility: hidden;">
	<textarea id="JSONArea" rows="14" cols="132"></textarea><br/>
	<input type="button" value="Import" onclick="javascript: localStorage . setItem ('galaxy/PBEM.txt', document . getElementById ('JSONArea') . value); galaxy . restore ('galaxy/PBEM.txt'); document . getElementById ('JSON') . style . visibility = 'hidden'; repaint ();"/>
	<input type="button" value="Export" onclick="javascript: galaxy . store ('galaxy/PBEM.txt'); document . getElementById ('JSONArea') . value = localStorage . getItem ('galaxy/PBEM.txt');"/>
	<input type="button" value="Close" onclick="javascript: document . getElementById ('JSON') . style . visibility = 'hidden';"/>
</div>

<div id="CreateRace" style="position: absolute; bottom: 8px; right: 256px; background-color: gold; border-radius: 8px; font-family: arial; padding: 8px;"><nobr>
	<div id="CreateRaces" style="float: left;"><table><tr><td>RACES:</td></tr></table></div>
	<div align="right" style="background-color: gold;">
		<nobr>
			<input type="button" value="CRT" onclick="javascript: document . getElementById ('Combat Result Table') . style . visibility = 'visible';"/>
			<select id="FileName">
			<option value="PBEM">PBEM</option>
			<option value="GALAXY 1">GALAXY 1</option>
			<option value="GALAXY 2">GALAXY 2</option>
			<option value="GALAXY 3">GALAXY 3</option>
			<option value="GALAXY 4">GALAXY 4</option>
			<option value="GALAXY 5">GALAXY 5</option>
			<option value="GALAXY 6">GALAXY 6</option>
			<option value="GALAXY 7">GALAXY 7</option>
			<option value="GALAXY 8">GALAXY 8</option>
		</select>
		<input type="button" value="Store" onclick="javascript: galaxy . store (`galaxy/${document . getElementById ('FileName') . value}.txt`); repaint ();"/>
		<input type="button" value="Restore" onclick="javascript: galaxy . restore (`galaxy/${document . getElementById ('FileName') . value}.txt`); repaint ();"/>
		<input type="button" value="Next" onclick="javascript: galaxy . Next (); repaint ();"/>
		<input type="button" value="I/O" onclick="javascript: document . getElementById ('JSON') . style . visibility = 'visible';"/></nobr>
	</div>
	<nobr><input type="button" value="Create New Race" onclick="javascript: if (document . getElementById ('CreateRaceName') . value . length > 0) {galaxy . CreateRace (document . getElementById ('CreateRaceName') . value, document . getElementById ('CreateRaceStar') . value, document . getElementById ('CreateRaceColour') . value); repaint ();} else alert ('No name for new race.');"/>
	<input type="text" id="CreateRaceName"/>
	<select id="CreateRaceStar">
	</select>
	<select id="CreateRaceColour">
		<option value="#6666ff" style="background-color: blue;">Blue</option>
		<option value="crimson" style="background-color: crimson;">Crimson</option>
		<option value="purple" style="background-color: indigo;">Purple</option>
		<option value="green" style="background-color: green;">Green</option>
		<option value="sienna" style="background-color: sienna;">Sienna</option>
		<option value="olive" style="background-color: olive;">Olive</option>
	</select>
	<input type="number" min="1" value="4" style="width: 5em;" id="Galaxy Width"/>
	<input type="number" min="1" value="4" style="width: 5em;" id="Galaxy Height"/>
	<input type="button" value="New Map" onclick="javascript: SelectedShip = null; galaxy . store ('galaxy/PBEM.txt'); galaxy = new Galaxy (Number (document . getElementById ('Galaxy Width') . value), Number (document . getElementById ('Galaxy Height') . value)); repaint ();"/>
	</nobr></nobr>
</div>

<canvas id="canvas" onmouseleave="javascript: return OnMouseUp (event);" onmousedown="javascript: return OnMouseDown (event);" onmousemove="javascript: OnMouseMove (event);" onmouseup="javascript: OnMouseUp (event);" oncontextmenu="javascript: event . preventDefault ();" width="400" height="200"/>

<script type="text/javascript" src="galaxy.js"></script>
<script type="text/javascript" src="ship.js"></script>

<script>

var SelectedShip = null;

var UpdateShipSelectDiv = function () {
	// console . log (galaxy . SelectedShip);
	if (! SelectedShip) document . getElementById ('ShipData') . innerHTML = '';
	else {
		var ship = SelectedShip . ship;
		var text = `<img src="${ship . icon}"/><br/><font color="${ship . colour}">${ship . race} ${ship . name}: ${ship . move}<br/>`;
		if (typeof ship . location === 'string') {
			if (galaxy . stars [ship . location]) text += `${ship . location} ${galaxy . stars [ship . location] . economy}`;
			else text += `${ship . location} docked`;
			var base = galaxy . races [ship . race] . bases [ship . location];
			if (base) {
			 	if (base . construction < 30) text += ` <${base . construction}>`; else text += ` [${base . BuildPoints}]`;
			}
		} else text += `Space [${ship . location . x} : ${ship . location . y}]`;
		text += `</font><br/>`;
		if (ship . race === galaxy . Turns [0]) {
			var CanRepair = SelectedShip . CanRepair ();
			if (CanRepair && ! SelectedShip . source) SelectedShip . Source (CanRepair);
			if (SelectedShip . source && galaxy . Phase === 'build') {
				text += `Source: ${SelectedShip . SourceName}`;
				if (SelectedShip . source . name) {
					text += ` <select id="SelectSource" onchange="javascript: if (this . value !== 'Select Source') SelectedShip . Source (this . value); repaint ();">`;
					text += `<option value="Select Source">Select Source</option>`;
					for (var s in galaxy . races [ship . race] . ships) {
						var S = galaxy . races [ship . race] . ships [s];
						if (S . Holds > 0) text += `<option value="${S . name}">${S . name}</option>`;
					}
					text += `</select>`;
				}
			}
			text += '<hr/>';
			if (ship . WarpGenerator) text += 'Warp Generator<br/>';
			text += `Power Drive = ${ship . PowerDrive} [${ship . original . PowerDrive}]`;
			if (CanRepair && ship . original . PowerDrive > ship . PowerDrive) text += ` <input type="button" value="REPAIR" style="padding: 0px;" onclick="javascript: SelectedShip . Repair ('PowerDrive', 1); repaint ();"/>`;
			text += `<br/>`;
			if (ship . original . Beams > 0) {
				text += `Beams = ${ship . Beams} [${ship . original . Beams}]`;
				if (CanRepair && ship . original . Beams > ship . Beams) text += ` <input type="button" value="REPAIR" style="padding: 0px;" onclick="javascript: SelectedShip . Repair ('Beams', 1); repaint ();"/>`;
				text += '<br/>';
			}
			if (ship . original . Shields > 0) {
				text += `Shields = ${ship . Shields} [${ship . original . Shields}]`;
				if (CanRepair && ship . original . Shields > ship . Shields) text += ` <input type="button" value="REPAIR" style="padding: 0px;" onclick="javascript: SelectedShip . Repair ('Shields', 1); repaint ();"/>`;
				text += `<br/>`;
			}
			if (ship . original . Tubes > 0) {
				text += `Tubes = ${ship . Tubes} [${ship . original . Tubes}]`;
				if (CanRepair && ship . original . Tubes > ship . Tubes) text += ` <input type="button" value="REPAIR" style="padding: 0px;" onclick="javascript: SelectedShip . Repair ('Tubes', 1); repaint ();"/>`;
				text += `<br/>`;
			}
			if (ship . original . Missiles > 0) {
				text += `Missiles = ${ship . Missiles} [${ship . original . Missiles}]`;
				if (CanRepair && ship . original . Missiles > ship . Missiles) text += ` <input type="button" value="REFILL" style="padding: 0px;" onclick="javascript: SelectedShip . Repair ('Missiles', 1, 3); repaint ();"/>`;
				text += `<br/>`;
				for (var ind = 0; ind < ship . Missiles; ind ++) text += `<img src="HarpoonV.png" height="128px;"/>`;
			}
			text += '<hr/>';
			if (ship . RepairBay) text += 'Repair Bay<br/>';
			if (ship . original . ECM > 0) {
				text += `ECM = ${ship . ECM} [${ship . original . ECM}]`;
				if (CanRepair && ship . original . ECM > ship . ECM) text += ` <input type="button" value="REPAIR" style="padding: 0px;" onclick="javascript: SelectedShip . Repair ('ECM', 1); repaint ();"/>`;
				text += `<br/>`;
			}
			if (ship . original . Armor > 0) {
				text += `Armor = ${ship . Armor} [${ship . original . Armor}]`;
				if (CanRepair && ship . original . Armor > ship . Armor) text += ` <input type="button" value="REPAIR" style="padding: 0px;" onclick="javascript: SelectedShip . Repair ('Armor', 1, 2); repaint ();"/>`;
				text += `<br/>`;
			}
			if (ship . original . Cannons > 0) {
				text += `Cannons = ${ship . Cannons} [${ship . original . Cannons}]`;
				if (CanRepair && ship . original . Cannons > ship . Cannons) text += ` <input type="button" value="REPAIR" style="padding: 0px;" onclick="javascript: SelectedShip . Repair ('Cannons', 1); repaint ();"/>`;
				text += `<br/>`;
				for (var ind = 0; ind < ship . Cannons; ind ++) {
					text += ` <img src="Cannon.png"/> `;
				}
				text += `<br/>`;
			}
			if (ship . original . Shells > 0) {
				text += `Shells = ${ship . Shells} [${ship . original . Shells}]`;
				if (CanRepair && ship . original . Shells > ship . Shells) text += ` <input type="button" value="REPAIR" style="padding: 0px;" onclick="javascript: SelectedShip . Repair ('Shells', 1, 6); repaint ();"/>`;
				text += `<br/>`;
				for (var ind = 0; ind < ship . Shells; ind += 24) {
					for (var sub = 0; sub < 24 && ind + sub < ship . Shells; sub ++) text += `<img src="shell.png" height="32"/>`;
					text += `<br/>`;
				}
			}
			if (ship . original . Holds > 0) {
				text += `Holds = ${ship . Holds} [${ship . original . Holds}]`;
				if (CanRepair && ship . original . Holds > ship . Holds) text += ` <input type="button" value="REPAIR" style="padding: 0px;" onclick="javascript: SelectedShip . Repair ('Holds', 1, 10); repaint ();"/>`;
				text += `<br/>`;
				text += `Build Points = ${ship . BuildPoints}<br/>`;
				if (typeof ship . location === 'string' && galaxy . Phase === 'build') {
					text += `<input type="button" value="LOAD" onclick="javascript: galaxy . LoadBuildPoints ('${ship . race}', '${ship . name}', 1); repaint ();" style="padding: 0px;"/>`;
					text += `<input type="button" value="UNLOAD" onclick="javascript: galaxy . LoadBuildPoints ('${ship . race}', '${ship . name}', -1); repaint ();" style="padding: 0px;"/><br/>`;
				}
			}
			
		}
		if (ship . race === galaxy . Turns [0] && ship . original . Bays > 0) {
			text += `Bays = ${ship . Bays . length} [${ship . original . Bays}]<br/>`;
			text += `<table><tr>`;
			for (var ind in ship . Bays) {
				var racesAt = null; if (galaxy . CombatLocation === ship . location) racesAt = galaxy . RacesAt (galaxy . CombatLocation);
				// console . log ('RACES:', racesAt);
				racesAt = racesAt && racesAt . length === 1 && racesAt [0] === ship . race;
				if (ship . Bays [ind] === null) {
					text += `<td style="background-color: gray;">EMPTY<br/>`;
					if (typeof ship . location === 'string') {
						if (galaxy . Phase !== 'combat' || racesAt) {
							text += `<select onchange="javascript: SelectedShip . Pick (this . value, '${ind}'); if (this . value !== 'Pick') repaint ();"><option>Pick</option>`;
							for (var s in galaxy . races [ship . race] . ships) {
								var ss = galaxy . races [ship . race] . ships [s];
								if (ss . location === ship . location && ! ss . WarpGenerator) text += `<option value="${ss . name}">${ss . name}</option>`;
							}
							text += `</select>`;
						}
					}
					text += `</td>`;
				} else if (ship . Bays [ind] === 'damage') {
					text += `<td style="background-color: gray;" align="center">DAMAGED`;
					if (CanRepair) text += `<br/><input type="button" value="REPAIR" onclick="javascript: SelectedShip . BayRepair (${ind}); repaint();"/>`;
					text += `</td>`;
				} else {
					var Docked = galaxy . races [ship . race] . ships [ship . Bays [ind]];
					text += `<td style="background-color: red; text-align: center;"><img src="${Docked . icon}" width="64"/><br/>`;
					if (typeof ship . location === 'string') {
						if (galaxy . Phase === 'combat' && ! racesAt) text += Docked . name;
						else text += `<input type="button" value="${Docked . name}" onclick="javascript: SelectedShip . Drop (${ind}); repaint ();"/>`;
					} else text += `${Docked . name}`;
					text += `</td>`;
				}
			}
			text += `</table></tr>`;
		}
		document . getElementById ('ShipData') . innerHTML = text;
	}
};

var SelectTarget = function (Order, order, value) {
	if (value === 'select') return;
	if (value === 'null') value = null;
	else {
		if (Order !== order) {
			var count = 0;
			for (var ind = 0; ind < Order . Tubes . length; ind ++) {if (Order . Tubes [ind] . Target) count ++;}
			if (order . PowerDrive >= 0 && count > galaxy . Ship (Order . ship) . Missiles) return;
			count = 0;
			for (var ind = 0; ind < Order . Cannons . length; ind ++) {if (Order . Cannons [ind] . Target) count += Order . Cannons [ind] . Shells;}
			// console . log ('selecting target', Order, order, value, order . PowerDrive, count, galaxy . Ship (Order . ship) . Shells);
			if (order . Shells >= 0 && count > galaxy . Ship (Order . ship) . Shells) return;
			Order . Beams = 0; Order . Shields = 0; Order . Target = null;
			for (var ind = 0; ind < Order . Bays . length; ind ++) Order . Bays [ind] = null;
			// CancelPotentialPickUpOrder (Order . ship);
		}
		// if (OrderTotalPD (Order) + 1 > galaxy . races [Order . race] . ships [Order . ship] . PowerDrive) return;
	}
	CancelPotentialPickUpOrder (Order . ship);
	order . Target = value;
};

var SelectPDForTube = function (ship, tube, delta) {
	var Tube = galaxy . Orders [ship] . Tubes [tube];
	Tube . PowerDrive += delta;
	if (Tube . PowerDrive < 0) Tube . PowerDrive = 0;
};

var SelectShipForPickup = function (Warship, Bay, Systemship) {
	if (Systemship === 'select') return;
	var Order = galaxy . Orders [Warship];
	if (Systemship === 'null') Systemship = null;
	else {
		Order . PowerDrive = 0; Order . Shields = 0;
		if (Order . Strategy === 'ATTACK') Order . Strategy = 'DODGE';
		for (var ind = 0; ind < Order . Tubes . length; ind ++) Order . Tubes [ind] . Target = null;
		for (var ind = 0; ind < Order . Cannons . length; ind ++) Order . Cannons [ind] . Target = null;
		var SOrder = galaxy . Orders [Systemship];
		SOrder . Target = null; SOrder . Beams = 0; SOrder . Target = null;
		for (var ind = 0; ind < SOrder . Tubes . length; ind ++) SOrder . Tubes [ind] . Target = null;
		for (var ind = 0; ind < SOrder . Cannons . length; ind ++) SOrder . Cannons [ind] . Target = null;
	}
	Order . Bays [Bay] = Systemship;
};

var DropShip = function (ship, bay, value) {
	var Order = galaxy . Orders [ship];
	if (value) {Order . PowerDrive = 0; Order . Shields = 0; if (Order . Strategy === 'ATTACK') Order . Strategy = 'DODGE';}
	for (var ind = 0; ind < Order . Tubes . length; ind ++) Order . Tubes [ind] . Target = null;
	for (var ind = 0; ind < Order . Cannons . length; ind ++) Order . Cannons [ind] . Target = null;
	// if (OrderTotalPD (Order) + 1 > galaxy . races [Order . races] . ships [Order . ship] . PowerDrive) return;
	Order . Bays [bay] = value ? 'drop' : null;
};

var SelectStrategy = function (ship, value) {
	if (value === 'select') return;
	var Order = galaxy . Orders [ship];
	if (value === 'ATTACK') {
		for (var ind = 0; ind < Order . Bays . length; ind ++) Order . Bays [ind] = null;
	}
	Order . Strategy = value;
};

var CancelPotentialPickUpOrder = function (ship) {
	var Ship = galaxy . Ship (ship);
	for (var order in galaxy . Orders) {
		var Order = galaxy . Orders [order];
		for (var ind = 0; ind < Order . Bays . length; ind ++) {
			if (Order . Bays [ind] === Ship . name) {
				Order . Bays [ind] = null;
			}
		}
	}
};

var SelectShells = function (ship, cannon, shells) {
	var Order = galaxy . Orders [ship];
	var count = 0;
	for (var ind = 0; ind < Order . Cannons . length; ind ++) count += ind === cannon ? shells : Order . Cannons [ind] . Shells;
	if (count > galaxy . Ship (ship) . Shells) return;
	Order . Cannons [cannon] . Shells = shells;
};

var UpdateCombatPanel = function () {
	var combats = galaxy . Combats ();
	document . getElementById ('CombatLocationDiv') . innerHTML = galaxy . CombatLocation;
	document . getElementById ('CombatLocation') . options . length = 0;
	document . getElementById ('CombatLocation') . options . add (new Option ('Select Combat Location', 'select'));
	for (var ind in combats) {
		document . getElementById ('CombatLocation') . options . add (new Option (combats [ind], combats [ind]));
	}
	document . getElementById ('CombatShip') . options . length = 0;
	var CompareRace = galaxy . Conflicts [galaxy . CombatLocation];
	if (CompareRace) CompareRace = CompareRace . races;
	if (CompareRace && CompareRace . length > 0) CompareRace = CompareRace [0];
	document . getElementById ('CombatShip') . options . add (new Option (`Select ${CompareRace ? (CompareRace === 'process' ? '----' : CompareRace) : '----'} Combat Ship`, 'select'));
	for (var race in galaxy . races) {
		var Race = galaxy . races [race];
		CompareRace = galaxy . Conflicts [galaxy . CombatLocation];
		if (CompareRace) {
			CompareRace = CompareRace . races;
			// console . log (CompareRace [0], race);
			if (CompareRace . length > 0 && CompareRace [0] === race) {
				for (var ship in Race . ships) {
					var Ship = Race . ships [ship];
					if (Ship . location === galaxy . CombatLocation) document . getElementById ('CombatShip') . options . add (new Option (`${race}: ${ship}`, ship));
				}
			}
		}
	}
	if (galaxy . CombatShip) {
		var ship = null;
		for (var race in galaxy . races) {
			var Race = galaxy . races [race];
			if (Race . ships [galaxy . CombatShip]) ship = Race . ships [galaxy . CombatShip];
		}
		if (ship) {
			var text = `<div style="float: left;"><img src="${ship . icon}"/><br/>`;
			text += `<font color="${ship . colour}">${ship . race} ${ship . name}</font>`;
			text += `<hr/>`;
			var order = galaxy . Orders [ship . name];
			text += `Strategy: ${order . Strategy} `;
			text += `<select onchange="javascript: SelectStrategy ('${ship . name}', this . value); repaint ();">`;
			text += `<option value="select">Select Strategy</option>`;
			text += `<option value="ATTACK">ATTACK</option>`;
			text += `<option value="DODGE">DODGE</option>`;
			if (ship . WarpGenerator) text += `<option value="RETREAT">RETREAT</option>`;
			text += `</select><br/>`;
			text += `Target: `;
			if (order . Target) text += `${order . Target} <img src="${galaxy . Ship (order . Target) . icon}" width="64"/> `;
			text += `<br/>`;
			text += `<select onchange="javascript: SelectTarget (galaxy . Orders ['${ship . name}'], galaxy . Orders ['${ship . name}'], this . value); repaint ();">`;
			var TargetOptions = `<option value="select">Select Target</option>`;
			TargetOptions += `<option value="null">NO TARGET</option>`;
			for (var race in galaxy . races) {
				var Race = galaxy . races [race];
				for (var ss in Race . ships) {
					var SS = Race . ships [ss];
					if (SS . location === ship . location && SS . race !== ship . race)
						TargetOptions += `<option value="${SS . name}">${SS . race}: ${SS . name}</option>`;
				}
			}
			text += `${TargetOptions}</select><br/>`;
			text += `<table>`;
			text += `<tr><td>Power Drive [${ship . PowerDrive}]: ${order . PowerDrive}</td><td>`;
			text += `<input type="button" value="▲" style="padding: 0px;" onclick="javascript: OrderAttr ('${ship . name}', 1, 'PowerDrive'); repaint ();"/>`;
			text += `<input type="button" value="▼" style="padding: 0px;" onclick="javascript: OrderAttr ('${ship . name}', -1, 'PowerDrive'); repaint ();"/></td></tr>`;
			text += `<tr><td>Beams [${ship . Beams}]: ${order . Beams}</td><td>`;
			text += `<input type="button" value="▲" style="padding: 0px;" onclick="javascript: OrderAttr ('${ship . name}', 1, 'Beams'); repaint ();"/>`;
			text += `<input type="button" value="▼" style="padding: 0px;" onclick="javascript: OrderAttr ('${ship . name}', -1, 'Beams'); repaint ();"/></td></tr>`;
			text += `<tr><td>Shields [${ship . Shields}]: ${order . Shields}</td><td>`;
			text += `<input type="button" value="▲" style="padding: 0px;" onclick="javascript: OrderAttr ('${ship . name}', 1, 'Shields'); repaint ();"/>`;
			text += `<input type="button" value="▼" style="padding: 0px;" onclick="javascript: OrderAttr ('${ship . name}', -1, 'Shields'); repaint ();"/></td></tr>`;
			text += `<tr><td>ECM [${ship . ECM}]: ${order . ECM}</td><td>`;
			text += `<input type="button" value="▲" style="padding: 0px;" onclick="javascript: OrderAttr ('${ship . name}', 1, 'ECM'); repaint ();"/>`;
			text += `<input type="button" value="▼" style="padding: 0px;" onclick="javascript: OrderAttr ('${ship . name}', -1, 'ECM'); repaint ();"/></td></tr>`;
			text += `</table>`;
			if (order . Bays . length > 0) {
				text += `<hr/>`;
				text += `<table><tr>`;
				var Systemships = `<option value="select">Pickup</option>`;
				Systemships += `<option value="null">NO PICKUP</option>`;
				for (var shipname in galaxy . races [ship . race] . ships) {
					var Systemship = galaxy . races [ship . race] . ships [shipname];
					if (Systemship . location === ship . location && ! Systemship . WarpGenerator)
						Systemships += `<option value="${shipname}">${shipname}</option>`;
				}
				for (var ind = 0; ind < order . Bays . length; ind ++) {
					if (ship . Bays [ind] === null) {
						text += `<td style="background-color: gray;" align="center">EMPTY<br/>`;
						if (order . Bays [ind] !== null) text += `<img src="${galaxy . Ship (order . Bays [ind]) . icon}" width="64"/><br/>${order . Bays [ind]}<br/>`;
						text += `<select onchange="javascript: SelectShipForPickup ('${ship . name}', ${ind}, this . value); repaint ();">`;
						text += Systemships;
						text += `</select>`;
						text += `</td>`;
					} else if (ship . Bays [ind] === 'damage') {
						text += `<td style="background-color: gray;" align="center">DAMAGED</td>`;
					} else {
						var Docked = galaxy . Ship (ship . Bays [ind]);
						text += `<td style="background-color: red;" align="center"><img src="${Docked . icon}" width="64"/><br/>${Docked . name}`;
						text += `<input type="checkbox" ${order . Bays [ind] === 'drop' ? 'checked' : ''} onchange="javascript: DropShip ('${ship . name}', ${ind}, this. checked); repaint ();"/></td>`;
					}
				}
				text += `</tr></table>`;
			}
			text += `</div>`;
			text += `<div style="float: right;">`;
			text += `<hr/>`;
			text += `Cannons [${ship . original . Cannons}]: ${ship . Cannons}<br/>`;
			text += `<table>`;
			for (var cannon = 0; cannon < galaxy . Orders [ship . name] . Cannons . length; cannon ++) {
				var CannonOrder = galaxy . Orders [ship . name] . Cannons [cannon];
				var TargetShip = galaxy . Ship (CannonOrder . Target);
				text += `<tr><td align="bottom">`;
				text += `<img src="Cannon.png"/> ${CannonOrder . Shells}`;
				text += `<input name="Cannon ${cannon}" type="radio" ${CannonOrder . Shells === 1 ? 'checked' : ''} onchange="javascript: SelectShells ('${ship . name}', ${cannon}, 1); repaint ();"/>`;
				text += `<input name="Cannon ${cannon}" type="radio" ${CannonOrder . Shells === 2 ? 'checked' : ''} onchange="javascript: SelectShells ('${ship . name}', ${cannon}, 2); repaint ();"/>`;
				text += `<input name="Cannon ${cannon}" type="radio" ${CannonOrder . Shells === 3 ? 'checked' : ''} onchange="javascript: SelectShells ('${ship . name}', ${cannon}, 3); repaint ();"/>`;
				text += `<br/>`;
				text += `<select onchange="javascript: SelectTarget (galaxy . Orders ['${ship . name}'], galaxy . Orders ['${ship . name}'] . Cannons [${cannon}], this . value); repaint ();">`;
				text += TargetOptions;
				text += `</select><br/>`;
				text += `</td><td valign="bottom">`;
				if (TargetShip) text += `<img src="${TargetShip . icon}" width="64"/><br/>${CannonOrder . Target}<br/>`;
				text += `</td></tr>`;
			}
			text += `</table>`;
			for (var ind = 0; ind < ship . Shells; ind += 24) {
				for (var sub = 0; sub < 24 && sub + ind < ship . Shells; sub ++) text += `<img src="shell.png" height="32"/>`;
				text += '<br/>';
			}
			text += `<hr/>`;
			text += `Tubes [${ship . original . Tubes}]: ${ship . Tubes}<br/>`;
			text += `<table>`;
			for (var tube = 0; tube < galaxy . Orders [ship . name] . Tubes . length; tube ++) {
				var TubeOrder = galaxy . Orders [ship . name] . Tubes [tube];
				var TargetShip = galaxy . Ship (TubeOrder . Target);
				text += `<tr><td valign="bottom">`;
				text += `<img src="Harpoon.png" width="128"/> `;
				text += `<br/>`;
				text += `<select onchange="javascript: SelectTarget (galaxy . Orders ['${ship . name}'], galaxy . Orders ['${ship . name}'] . Tubes [${tube}], this . value); repaint ();">`;
				text += TargetOptions;
				text += `</select><br/>`;
				text += `Drive: ${TubeOrder . PowerDrive} `;
				text += `<input type="button" value="▲" style="padding: 0px;" onclick="javascript: SelectPDForTube ('${ship . name}', ${tube}, 1); repaint ();"/>`;
				text += `<input type="button" value="▼" style="padding: 0px;" onclick="javascript: SelectPDForTube ('${ship . name}', ${tube}, -1); repaint ();"/>`;
				text += `</td><td valign="bottom">`;
				if (TargetShip) text +=  `<img src="${TargetShip . icon}" width="64"/><br/>${TubeOrder . Target}<br/>`;
				text += `</td></tr>`;
			}
			text += `</table>`;
			for (var ind = 0; ind < ship . Missiles; ind ++) text += `<img src="HarpoonV.png" height="96"/>`;
			text += `<hr/>`;
			text += `</div>`;
			document . getElementById ('CombatShipData') . innerHTML = text;
		}
	} else document . getElementById ('CombatShipData') . innerHTML = '';
};

var OrderTotalPD = function (Order) {
	var total = Order . PowerDrive + Order . Beams + Order . Shields + Order . ECM;
	// for (var ind = 0; ind < Order . Bays . length; ind ++) {if (Order . Bays [ind]) total ++;}
	for (var ind = 0; ind < Order . Tubes . length; ind ++) {if (Order . Tubes [ind] . Target) total ++;}
	for (var ind = 0; ind < Order . Cannons . length; ind ++) {if (Order . Cannons [ind] . Target) total ++;}
	return total;
};

var OrderAttr = function (ship, delta, attr) {
	var Order = galaxy . Orders [ship];
	var Ship = galaxy . races [Order . race] . ships [ship];
	if (attr === 'Beams' || attr === 'Shields') {
		for (var ind = 0; ind < Order . Tubes . length; ind ++) Order . Tubes [ind] . Target = null;
		for (var ind = 0; ind < Order . Cannons . length; ind ++) Order . Cannons [ind] . Target = null;
	}
	if (attr === 'PowerDrive' || attr === 'Shields') {
		for (var ind = 0; ind < Order . Bays . length; ind ++) Order . Bays [ind] = null;
	}
	if (attr === 'Beams' && delta > 0) CancelPotentialPickUpOrder (ship);
	if (OrderTotalPD (Order) + delta > Ship . PowerDrive) return;
	Order [attr] += delta; if (Order [attr] < 0) Order [attr] = 0; if (Order [attr] > Ship [attr]) Order [attr] = Ship [attr];
}

var RestoreSelects = function () {
	var Stars = [];
	for (var star in galaxy . stars) Stars . push (star);
	Stars . sort ();
	document . getElementById ('CreateRaceStar') . options . length = 0;
	for (var star of Stars) {
		document . getElementById ('CreateRaceStar') . add (new Option (`${galaxy . stars [star] . economy}: ${star}`, star));
		// document . getElementById ('BuildLocations') . add (new Option (`${star} ${galaxy . stars [star] . economy}`, star));
	}
	document . getElementById ('BuildLocations') . options . length = 0;
	if (galaxy . Turns . length > 0) {
		for (var base in galaxy . races [galaxy . Turns [0]] . bases) {
			var Base = galaxy . races [galaxy . Turns [0]] . bases [base];
			var Star = galaxy . stars [base];
			if (Base . construction < 30) document . getElementById ('BuildLocations') . add (new Option (`${Star . economy}: ${base} <${Base . construction}>`, base));
			else document . getElementById ('BuildLocations') . add (new Option (`${Star . economy}: ${base} [${Base . BuildPoints}]`, base));
		}
	}
	document . getElementById ('ShipsForSelection') . options . length = 0;
	document . getElementById ('ShipsForSelection') . add (new Option ('none', 'none'));
	for (var race in galaxy . races) {
		for (var ship in galaxy . races [race] . ships) {
			document . getElementById ('ShipsForSelection') . add (new Option (`${race}: ${ship}`, ship));
		}
	}
	// document . getElementById ('GameStatus') . innerHTML = `Phase: ${galaxy . Phase}; Turn: ${galaxy . Turns [0] || 'none'}; TL: ${galaxy . TechnologyLevel};`;
	UpdateShipSelectDiv ();
	UpdateCombatPanel ();
	switch (galaxy . Phase) {
	case 'build':
		document . getElementById ('BuildPanel') . style . visibility = 'visible';
		document . getElementById ('CombatPanel') . style . visibility = 'hidden';
		break;
	case 'move':
		document . getElementById ('BuildPanel') . style . visibility = 'hidden';
		document . getElementById ('CombatPanel') . style . visibility = 'hidden';
		break;
	case 'combat':
		document . getElementById ('BuildPanel') . style . visibility = 'hidden';
		document . getElementById ('CombatPanel') . style . visibility = 'visible';
		break;
	case 'rearrange':
		document . getElementById ('BuildPanel') . style . visibility = 'hidden';
		document . getElementById ('CombatPanel') . style . visibility = 'hidden';
		break;
	default:
		document . getElementById ('BuildPanel') . style . visibility = 'hidden';
		document . getElementById ('CombatPanel') . style . visibility = 'hidden';
		break;
	}
};

var BuildShipReset = function () {
	document . getElementById ('BuildWarpGenerator') . checked = false;
	document . getElementById ('BuildRepairBay') . checked = false;
	document . getElementById ('BuildPowerDrive') . value = 0;
	document . getElementById ('BuildBeams') . value = 0;
	document . getElementById ('BuildShields') . value = 0;
	document . getElementById ('BuildECM') . value = 0;
	document . getElementById ('BuildTubes') . value = 0;
	document . getElementById ('BuildMissiles') . value = 0;
	document . getElementById ('BuildArmor') . value = 0;
	document . getElementById ('BuildCannons') . value = 0;
	document . getElementById ('BuildShells') . value = 0;
	document . getElementById ('BuildBays') . value = 0;
	document . getElementById ('BuildHolds') . value = 0;
};

var BuildShip = function () {
	var location = document . getElementById ('BuildLocations') . value;
	var ship = galaxy . CreateShip (document . getElementById ('BuildLocations') . value);
	if (ship === null) return null;
	if (document . getElementById ('BuildWarpGenerator') . checked) ship . WarpGenerator ();
	if (document . getElementById ('BuildRepairBay') . checked) ship . RepairBay ();
	var PowerDrive = Number (document . getElementById ('BuildPowerDrive') . value); if (PowerDrive > 0) ship . PowerDrive (PowerDrive);
	var Beams = Number (document . getElementById ('BuildBeams') . value); if (Beams > 0) ship . Beams (Beams);
	var Shields = Number (document . getElementById ('BuildShields') . value); if (Shields > 0) ship . Shields (Shields);
	var ECM = Number (document . getElementById ('BuildECM') . value); if (ECM > 0) ship . ECM (ECM);
	var Tubes = Number (document . getElementById ('BuildTubes') . value); if (Tubes > 0) ship . Tubes (Tubes);
	var Missiles = Number (document . getElementById ('BuildMissiles') . value); if (Missiles > 0) ship . Missiles (Missiles);
	var Armor = Number (document . getElementById ('BuildArmor') . value); if (Armor > 0) ship . Armor (Armor);
	var Cannons = Number (document . getElementById ('BuildCannons') . value); if (Cannons > 0) ship . Cannons (Cannons);
	var Shells = Number (document . getElementById ('BuildShells') . value); if (Shells > 0) ship . Shells (Shells);
	var Bays = Number (document . getElementById ('BuildBays') . value); if (Bays > 0) ship . Bays (Bays);
	var Holds = Number (document . getElementById ('BuildHolds') . value); if (Holds > 0) ship . Holds (Holds);
	// console . log (ship);
	ShipSelect (ship . ship . name);
	return ship;
};

var canvas = document . getElementById ('canvas');
var ctx = canvas . getContext ('2d');

var ShipSelect = function (name) {SelectedShip = galaxy . ShipSelect (name); repaint ();};

var repaint = function () {
	canvas . width = window . innerWidth;
	canvas . height = window . innerHeight;
	ctx . save ();
	// ctx . drawImage (Icons ['b8.png'], 200, 200);
	galaxy . draw ();
	if (Object . keys (galaxy . races) . length > 0) {
		ctx . fillStyle = galaxy . races [galaxy . Turns [0]] . colour;
		ctx . font = '24px arial';
		ctx . textAlign = 'left';
		ctx . textAlign = 'center';
		ctx . fillText (`${galaxy . Turns [0]} ${galaxy . Phase} TL = [${galaxy . TechnologyLevel}]`, canvas . width * 0.5, 32);
		if (galaxy . Phase === 'combat' && galaxy . CombatLocation) {
			ctx . fillText (`Conflict at ${galaxy . CombatLocation}`, canvas . width * 0.5, 64);
			// console . log (galaxy . Conflicts);
			var conflict = galaxy . Conflicts [galaxy . CombatLocation];
			if (conflict . races . length > 1) {
				ctx . fillStyle = galaxy . races [conflict . races [0]] . colour;
				ctx . fillText (`Orders for ${galaxy . Conflicts [galaxy . CombatLocation] . races [0]}`, canvas . width * 0.5, 96);
			} else {
				ctx . fillStyle = galaxy . races [galaxy . Turns [0]] . colour;
				ctx . fillText (`Process orders for ${galaxy . CombatLocation}.`, canvas . width * 0.5, 96);
				// galaxy . DrawReport ();
			}
		}
	}
	ctx . restore ();
	RestoreSelects ();
	RefitRaces ();
	// ctx . fillRect (0, 0, canvas . width, canvas . height);
};

var MouseLocation = {x: 0, y: 0};
var dragging = false;

var OnMouseDown = function (e) {
	e . preventDefault ();
	MouseLocation = {x: e . clientX, y: e . clientY};
	dragging = true;
	if (galaxy . Phase === 'move' && SelectedShip) {
		var fraction = Math . pow (3, 0.5);
		var hit = {
			x: 0.5 + (e . clientX - galaxy . shift . x - galaxy . size . radius) / (galaxy . size . radius * fraction),
			y: Math . floor (0.5 + (e . clientY - galaxy . shift . y - galaxy . size . radius) / (galaxy . size . radius * 1.5))
		};
		hit . x = Math . floor (hit . x + hit . y * 0.5);
		var star = galaxy . StarAt (hit . x, hit . y);
		var ShipLocation = SelectedShip . ship . location;
		if (star && typeof ShipLocation === 'string') hit = star;
		if (typeof ShipLocation === 'string') ShipLocation = galaxy . stars [ShipLocation] . location;
		// console . log ('Move', SelectedShip . ship . name, ShipLocation, star, hit);
		if (typeof hit !== 'string' && typeof ShipLocation !== 'string') {hit . x -= ShipLocation . x; hit . y -= ShipLocation . y;}
		SelectedShip . move (hit);
		repaint ();
	}
	return false;
};

var OnMouseUp = function () {dragging = false;};

var OnMouseMove = function (e) {
	if (! dragging) return;
	var point = {x: e . clientX, y: e . clientY};
	var delta = {x: point . x - MouseLocation . x, y: point . y - MouseLocation . y};
	galaxy . shift . x += delta . x; galaxy . shift . y += delta . y;
	// console . log (delta);
	MouseLocation = point;
	repaint ();
};

var RefitRaces = function () {
	var table = '<table><tr><td>RACES:</td>';
	for (var race in galaxy . races) table += `<td bgcolor="${galaxy . races [race] . colour}"><font color="white">${race}</font></td>`;
	table += '</tr></table>';
	document . getElementById ('CreateRaces') . innerHTML = table;
};

for (var ind = 0; ind < Galaxy . prototype . names . length; ind ++) {
	var name = Galaxy . prototype . names [ind];
	var count = 0;
	for (var sub = 0; sub < Galaxy . prototype . names . length; sub ++) {
		if (Galaxy . prototype . names [ind] === Galaxy . prototype . names [sub]) count ++;
	}
	if (count > 1) console . log (Galaxy . prototype . names [ind], count);
}

var galaxy = new Galaxy (28, 14);
document . body . style ['background-color'] = galaxy . BackgroundColour;
galaxy . restore ('galaxy/PBEM.txt');
repaint ();

</script>

</body>
</html>

